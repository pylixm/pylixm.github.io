<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.24" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.160" /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Kubernetes 学习笔记-集群搭建篇(二进制方式)","image":["https://pylixm.top/imgs/k8s/k8s-architecture.png","https://pylixm.top/imgs/k8s/k8s-ha.png","https://pylixm.top/imgs/k8s/k8s-ha-2.png"],"dateModified":"2025-09-30T08:57:49.000Z","author":[]}</script><meta property="og:url" content="https://pylixm.top/pages/a21d6c/"><meta property="og:site_name" content="底层逻辑"><meta property="og:title" content="Kubernetes 学习笔记-集群搭建篇(二进制方式)"><meta property="og:description" content="本篇记录我集群搭建的过程和问题，目标是可以根据本篇文章搭建自己生产可用的K8S集群。对于K8S的一些概念理解，可参考我之前的笔记Kubernetes 学习笔记-基础篇。 环境准备 容器环境对Linux的系统内核有一定的要求， kernel 3.10 是当前Docker 19 可以稳定运行的最小的Linux内核版本。Docker 中应用了很多内核中的新功..."><meta property="og:type" content="article"><meta property="og:image" content="https://pylixm.top/imgs/k8s/k8s-architecture.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-09-30T08:57:49.000Z"><meta property="article:tag" content="docker"><meta property="article:tag" content="Kubernetes"><meta property="article:modified_time" content="2025-09-30T08:57:49.000Z"><link rel="icon" type="image/png" href="/imgs/favicon-w.ico"><title>Kubernetes 学习笔记-集群搭建篇(二进制方式) | 底层逻辑</title><meta name="description" content="本篇记录我集群搭建的过程和问题，目标是可以根据本篇文章搭建自己生产可用的K8S集群。对于K8S的一些概念理解，可参考我之前的笔记Kubernetes 学习笔记-基础篇。 环境准备 容器环境对Linux的系统内核有一定的要求， kernel 3.10 是当前Docker 19 可以稳定运行的最小的Linux内核版本。Docker 中应用了很多内核中的新功..."><link rel="preload" href="/assets/style-CHwxVUp-.css" as="style"><link rel="stylesheet" href="/assets/style-CHwxVUp-.css"><link rel="modulepreload" href="/assets/app-DdES4ywf.js"><link rel="modulepreload" href="/assets/index.html-C5LSLlB0.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-cb0e7d0c><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-00860fbe></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-00860fbe> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-cb0e7d0c data-v-2ec99593><div class="vp-navbar" vp-navbar data-v-2ec99593 data-v-0a6e0ca2><div class="wrapper" data-v-0a6e0ca2><div class="container" data-v-0a6e0ca2><div class="title" data-v-0a6e0ca2><div class="vp-navbar-title" data-v-0a6e0ca2 data-v-9ac90eb2><a class="vp-link link no-icon title" href="/" data-v-9ac90eb2><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="/imgs/avatar.png" alt data-v-cd797be5><!--]--><!--[--><img class="vp-image light logo" style="" src="/imgs/avatar.png" alt data-v-cd797be5><!--]--><!--]--><!--]--><span data-v-9ac90eb2>底层逻辑</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-0a6e0ca2><div class="content-body" data-v-0a6e0ca2><!--[--><!--]--><div class="vp-navbar-search search" data-v-0a6e0ca2><div class="search-wrapper" data-v-e2e52c8d><!----><div id="local-search" data-v-e2e52c8d><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-e2e52c8d><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><!--[--><!--]--><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-0a6e0ca2 data-v-ab484cfa><span id="main-nav-aria-label" class="visually-hidden" data-v-ab484cfa>Main Navigation</span><!--[--><!--[--><a class="vp-link link navbar-menu-link" href="/" tabindex="0" data-v-ab484cfa data-v-7ece5e7c><!--[--><!----><span data-v-7ece5e7c>首页</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/" tabindex="0" data-v-ab484cfa data-v-7ece5e7c><!--[--><!----><span data-v-7ece5e7c>博客</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/tags/" tabindex="0" data-v-ab484cfa data-v-7ece5e7c><!--[--><!----><span data-v-7ece5e7c>标签</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/archives/" tabindex="0" data-v-ab484cfa data-v-7ece5e7c><!--[--><!----><span data-v-7ece5e7c>归档</span><!----><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-ab484cfa data-v-7401cb95><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-7401cb95><span class="text" data-v-7401cb95><!----><!----><span data-v-7401cb95>系列笔记</span><!----><span class="vpi-chevron-down text-icon" data-v-7401cb95></span></span></button><div class="menu" data-v-7401cb95><div class="vp-menu" data-v-7401cb95 data-v-06a49bfc><div class="items" data-v-06a49bfc><!--[--><!--[--><div class="vp-menu-link" data-v-06a49bfc data-v-9779e938><a class="vp-link link" href="/opensource/" data-v-9779e938><!--[--><!----> 开源资源汇总 <!----><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-06a49bfc data-v-9779e938><a class="vp-link link" href="/self-manage/" data-v-9779e938><!--[--><!----> 自我管理 <!----><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-06a49bfc data-v-9779e938><a class="vp-link link" href="/compare-python-go/" data-v-9779e938><!--[--><!----> 对比python学习go <!----><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-06a49bfc data-v-9779e938><a class="vp-link link" href="/git/" data-v-9779e938><!--[--><!----> Git学习笔记 <!----><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-06a49bfc data-v-9779e938><a class="vp-link link" href="/data-structure-algorithm/" data-v-9779e938><!--[--><!----> 数据结构与算法笔记 <!----><!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!--[--><!--]--><!----><div class="vp-navbar-appearance appearance" data-v-0a6e0ca2 data-v-cc24382d><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-cc24382d data-v-aec06342 data-v-9492f210><span class="check" data-v-9492f210><span class="icon" data-v-9492f210><!--[--><span class="vpi-sun sun" data-v-aec06342></span><span class="vpi-moon moon" data-v-aec06342></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-0a6e0ca2 data-v-1b1494c0 data-v-d2122b65><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-d2122b65 data-v-24ceb10e><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-0a6e0ca2 data-v-c5b848b7 data-v-7401cb95><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-7401cb95><span class="vpi-more-horizontal icon" data-v-7401cb95></span></button><div class="menu" data-v-7401cb95><div class="vp-menu" data-v-7401cb95 data-v-06a49bfc><!----><!--[--><!--[--><!----><div class="group" data-v-c5b848b7><div class="item appearance" data-v-c5b848b7><p class="label" data-v-c5b848b7>外观</p><div class="appearance-action" data-v-c5b848b7><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-c5b848b7 data-v-aec06342 data-v-9492f210><span class="check" data-v-9492f210><span class="icon" data-v-9492f210><!--[--><span class="vpi-sun sun" data-v-aec06342></span><span class="vpi-moon moon" data-v-aec06342></span><!--]--></span></span></button></div></div></div><div class="group" data-v-c5b848b7><div class="item social-links" data-v-c5b848b7><div class="vp-social-links social-links-list" data-v-c5b848b7 data-v-d2122b65><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-d2122b65 data-v-24ceb10e><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-0a6e0ca2 data-v-bdb5cb14><span class="container" data-v-bdb5cb14><span class="top" data-v-bdb5cb14></span><span class="middle" data-v-bdb5cb14></span><span class="bottom" data-v-bdb5cb14></span></span></button></div></div></div></div><div class="divider" data-v-0a6e0ca2><div class="divider-line" data-v-0a6e0ca2></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-cb0e7d0c data-v-580856f0><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-580856f0><span class="vpi-align-left menu-icon" data-v-580856f0></span><span class="menu-text" data-v-580856f0>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-580856f0 data-v-0695a3a1><button data-v-0695a3a1>返回顶部</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-cb0e7d0c data-v-4b2081f1><div class="vp-doc-container is-blog" data-v-4b2081f1 data-v-f3eb9d47><!--[--><!--]--><div class="container" data-v-f3eb9d47><!----><div class="content" data-v-f3eb9d47><div class="content-container" data-v-f3eb9d47><!--[--><!--]--><main class="main" data-v-f3eb9d47><nav class="vp-breadcrumb" data-v-f3eb9d47 data-v-7b225348><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-7b225348><!--[--><li property="itemListElement" typeof="ListItem" data-v-7b225348><a class="vp-link link breadcrumb" href="/" property="item" typeof="WebPage" data-v-7b225348><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-7b225348></span><meta property="name" content="首页" data-v-7b225348><meta property="position" content="1" data-v-7b225348></li><li property="itemListElement" typeof="ListItem" data-v-7b225348><a class="vp-link link breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-7b225348><!--[-->博客<!--]--><!----></a><span class="vpi-chevron-right" data-v-7b225348></span><meta property="name" content="博客" data-v-7b225348><meta property="position" content="2" data-v-7b225348></li><li property="itemListElement" typeof="ListItem" data-v-7b225348><a class="vp-link link breadcrumb" href="/blog/categories/?id=e467f5" property="item" typeof="WebPage" data-v-7b225348><!--[-->云原生<!--]--><!----></a><span class="vpi-chevron-right" data-v-7b225348></span><meta property="name" content="云原生" data-v-7b225348><meta property="position" content="3" data-v-7b225348></li><li property="itemListElement" typeof="ListItem" data-v-7b225348><a class="vp-link link breadcrumb" href="/blog/categories/?id=315d2b" property="item" typeof="WebPage" data-v-7b225348><!--[-->k8s<!--]--><!----></a><span class="vpi-chevron-right" data-v-7b225348></span><meta property="name" content="k8s" data-v-7b225348><meta property="position" content="4" data-v-7b225348></li><li property="itemListElement" typeof="ListItem" data-v-7b225348><a class="vp-link link breadcrumb current" href="/pages/a21d6c/" property="item" typeof="WebPage" data-v-7b225348><!--[-->Kubernetes 学习笔记-集群搭建篇(二进制方式)<!--]--><!----></a><!----><meta property="name" content="Kubernetes 学习笔记-集群搭建篇(二进制方式)" data-v-7b225348><meta property="position" content="5" data-v-7b225348></li><!--]--></ol></nav><!--[--><!--]--><!--[--><h1 class="vp-doc-title page-title" data-v-13458a91><!----> Kubernetes 学习笔记-集群搭建篇(二进制方式) <!----></h1><div class="vp-doc-meta" data-v-13458a91><!--[--><!--]--><p class="reading-time" data-v-13458a91><span class="vpi-books icon" data-v-13458a91></span><span data-v-13458a91>约 7055 字</span><span data-v-13458a91>大约 24 分钟</span></p><p data-v-13458a91><span class="vpi-tag icon" data-v-13458a91></span><!--[--><a class="vp-link link tag vp-tag-ay1g" href="/blog/tags/?tag=Kubernetes" data-v-13458a91><!--[-->Kubernetes<!--]--><!----></a><a class="vp-link link tag vp-tag-o5x4" href="/blog/tags/?tag=docker" data-v-13458a91><!--[-->docker<!--]--><!----></a><!--]--></p><!--[--><!--]--><p class="create-time" data-v-13458a91><span class="vpi-clock icon" data-v-13458a91></span><span data-v-13458a91>2023-09-08</span></p></div><!--]--><!--[--><!--]--><div class="_pages_a21d6c_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-f3eb9d47><!--[--><!--]--><div data-v-f3eb9d47><blockquote><p>本篇记录我集群搭建的过程和问题，目标是可以根据本篇文章搭建自己生产可用的K8S集群。对于K8S的一些概念理解，可参考我之前的笔记<a href="https://pylixm.cc/posts/2020-08-20-k8s-base.html" target="_blank" rel="noopener noreferrer">Kubernetes 学习笔记-基础篇</a>。</p></blockquote><h2 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备"><span>环境准备</span></a></h2><p>容器环境对Linux的系统内核有一定的要求， <code>kernel 3.10</code> 是当前Docker 19 可以稳定运行的最小的Linux内核版本。Docker 中应用了很多内核中的新功能，经过大量的实践证明，使用你当前发行版本Linux的最新稳定的内核是最佳的选择。</p><p>通过下边的脚本，可以检测依赖环境的可用性：</p><blockquote><p>https://github.com/docker/docker/blob/master/contrib/check-config.sh</p></blockquote><p>K8S 官方建议集群硬件最小配置为，2G 内存，2个cpu, 30G硬盘。若集群仅作为学习使用，官方提供了 <code>Minikube</code>和<code>Kind</code>两种方式，可安装简易版的K8S，来熟悉了解K8S的各种组件和功能。针对Mac 用户，<code>Docker for Mac</code>的客户端也集成了K8S的功能，也可启用来体验。</p><ul><li><code>Minikube</code> 和 <code>Kind</code> 方式安装K8S <a href="https://kubernetes.io/docs/setup/learning-environment/" target="_blank" rel="noopener noreferrer">安装文档</a>;</li><li><code>Docker for Mac</code> <a href="https://docs.docker.com/docker-for-mac/#kubernetes" target="_blank" rel="noopener noreferrer">启用文档</a>;</li></ul><p>本次目标搭建生产可用的集群，环境准备如下：</p><ul><li>6台Liunux机器，CentOS 7.8, Kernel 3.10.0-1127.18.2.el7.x86_64 <ul><li>192.168.10.11</li><li>192.168.10.12</li><li>192.168.10.13</li><li>192.168.10.14</li><li>192.168.10.15</li><li>192.168.10.16</li></ul></li><li>Docker: 18.09.9</li><li>Kubernetes: 1.16.14 (考虑到内核版本比较低，选择了较低版本，k8s 1.18 部署相同)</li><li>ETCD: 3.4.9</li></ul><h3 id="环境规划" tabindex="-1"><a class="header-anchor" href="#环境规划"><span>环境规划</span></a></h3><p>规划K8S的各组件机器如下：</p><ul><li><p>ETCD</p><ul><li>192.168.10.14</li><li>192.168.10.15</li><li>192.168.10.16</li></ul></li><li><p>K8S Master</p><ul><li>192.168.10.11 host: 10-11-master</li><li>192.168.10.12 host: 10-12-master</li><li>192.168.10.13 host: 10-13-master</li></ul></li><li><p>K8S Node</p><ul><li>192.168.10.14 host: 10-14-node</li><li>192.168.10.15 host: 10-15-node</li><li>192.168.10.16 host: 10-16-node</li></ul></li><li><p>Nginx + Keepalived</p><ul><li>192.168.10.14</li><li>192.168.10.15</li></ul></li></ul><p>这里Node和高可用组件都共用了ETCD的机器，这里仅作为演示说明，真实生产环境中建议都使用单独的机器部署，以免组件或机器故障相互影响。</p><h3 id="环境初始化" tabindex="-1"><a class="header-anchor" href="#环境初始化"><span>环境初始化</span></a></h3><p>以下操作，Master和Node机器需要执行。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 设置系统host，如192.169.10.11 host 为 10-11-master。其他机器修改方式相同。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> hostnamectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  set-hostname</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  10-11-master</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">127.0.0.1   </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">$(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">hostname</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/hosts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 升级系统内核</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/yum.repos.d/CentOS-Base.repo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/yum.repos.d/CentOS-Base.repo_bak</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -O</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/yum.repos.d/CentOS-Base.repo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://mirrors.aliyun.com/repo/Centos-7.repo</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clean</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> all</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> update</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 关闭防火墙</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stop</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> firewalld</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> disable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> firewalld</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 关闭swap </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">swapoff</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -a</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s/.*swap.*/#&amp;/</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/fstab</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 关闭SeLinux </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">setenforce  0 </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed -i </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/sysconfig/selinux </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed -i </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/selinux/config </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed -i </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/sysconfig/selinux </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sed -i </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;s/^SELINUX=permissive/SELINUX=disabled/g&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /etc/selinux/config </span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 设置内核参数</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/sysctl.d/k8s.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.ip_forward = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.bridge.bridge-nf-call-ip6tables = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.bridge.bridge-nf-call-iptables = 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_keepalive_time = 600</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_keepalive_intvl = 30</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">net.ipv4.tcp_keepalive_probes = 10</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">modprobe</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> br_netfilter</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sysctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/sysctl.d/k8s.conf</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ls</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /proc/sys/net/bridge</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 配置资源限制</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">* soft nofile 65536</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/security/limits.conf</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">* hard nofile 65536</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/security/limits.conf</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">* soft nproc 65536</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  &gt;&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/security/limits.conf</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">* hard nproc 65536</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  &gt;&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/security/limits.conf</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">* soft memlock  unlimited</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  &gt;&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/security/limits.conf</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">* hard memlock  unlimited</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  &gt;&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/security/limits.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 依赖安装</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> epel-release</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> yum-utils</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> device-mapper-persistent-data</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> lvm2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> net-tools</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> conntrack-tools</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ntpdate</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> libseccomp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> libtool-ltdl</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 安装Docker  </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum makecache fast</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum -y install docker-ce-18.09.9 docker-ce-cli-18.09.9</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl enable docker.service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl start docker.service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl stop docker.service</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/docker/daemon.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;registry-mirrors&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;https://4xr1qpsp.mirror.aliyuncs.com&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;https://dockerhub.azk8s.cn&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;http://hub-mirror.c.163.com&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;https://registry.docker-cn.com&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  ],</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;storage-opts&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;overlay2.override_kernel_check=true&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  ],</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;log-driver&quot;: &quot;json-file&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;log-opts&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;max-size&quot;: &quot;100m&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;max-file&quot;:&quot;5&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl start docker</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="组件安装" tabindex="-1"><a class="header-anchor" href="#组件安装"><span>组件安装</span></a></h2><p>机器环境初始化好之后，开始搭建K8S。主要有两种搭建方式：</p><ul><li><p>kubeadm：官方提供的安装工具，除管理容器的组件kubelet外，其他组件均以容器的形式启动。可通过 <code>kubeadm init</code> 和 <code>kubeadm join</code>来快速实现K8S集群的搭建。官方地址：https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/ 。 更加详细的安装步骤，可参考扩展阅读1。</p></li><li><p>二进制方式搭建：K8S 的各组件都是使用Go语言开发的，发布运行都是编译好的二进制文件。该方式需要自己来安装每个组件，自己编写配置文件和管理启动文件。</p></li></ul><p>初学者，本着学习的目的，本文记录第二种安装方式，以便熟悉K8S的各组件。老手完全可以使用 kubeadm 来快速搭建一个生产可用的集群。</p><p>在搭建集群之前，回忆下K8S的各组件。</p><p><img src="/imgs/k8s/k8s-architecture.png" alt=""></p><p>那我们梳理部署组件情况如下：</p><ul><li><p>单独集群部署：</p><ul><li>etcd 保存了整个集群的状态；</li></ul></li><li><p>Master 部署：</p><ul><li>controller manager 负责维护集群的状态，比如故障检测、自动扩展、滚动更新等；</li><li>scheduler 负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上；</li><li>apiserver 提供了资源操作的唯一入口，并提供认证、授权、访问控制、API注册和发现等机制；</li></ul></li><li><p>Node 部署：</p><ul><li>kubelet 负责维护容器的生命周期，同时也负责容器卷插件Volume（CVI）和容器网络插件（CNI）的管理；</li><li>kube-proxy 负责为Service提供cluster内部的服务发现和负载均衡；</li><li>Container runtime 负责镜像管理以及Pod和容器的真正运行（CRI）；</li></ul></li></ul><p>下面开始。</p><h3 id="_1-etcd-集群的搭建" tabindex="-1"><a class="header-anchor" href="#_1-etcd-集群的搭建"><span>1/ ETCD 集群的搭建</span></a></h3><p>ETCD主要用来保存集群状态和资源对象数据。使用kubeadm 安装时，默认<code>etcd</code>集群和Master节点是在一块的。为提高可用性减少故障影响，建议将<code>etcd</code>单独部署一个集群，方便管理维护。</p><h4 id="_1-1-签发证书" tabindex="-1"><a class="header-anchor" href="#_1-1-签发证书"><span>1.1/ 签发证书</span></a></h4><p>为提高安全性，统一使用ssl加密。可使用自签证书，我们使用 cfssl 工具来生成证书。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 下载cfssl 二进制文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 增加执行权限</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">chmod</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> +x</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cfssl_linux-amd64</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cfssljson_linux-amd64</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cfssl-certinfo_linux-amd64</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 移动到可执行目录</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cfssl_linux-amd64</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/cfssl</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cfssljson_linux-amd64</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/local/bin/cfssljson</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cfssl-certinfo_linux-amd64</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/bin/cfssl-certinfo</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>生成根证书</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span># 创建目录存放证书文件</span></span>
<span class="line"><span>mkdir -p /opt/ssl/{etcd,k8s}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 创建根证书配置文件， 有效期为87600h(10年)。</span></span>
<span class="line"><span>cd /opt/ssl/etcd</span></span>
<span class="line"><span>cat &gt; ca-config.json &lt;&lt; EOF</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>  &quot;signing&quot;: {</span></span>
<span class="line"><span>    &quot;default&quot;: {</span></span>
<span class="line"><span>      &quot;expiry&quot;: &quot;87600h&quot;</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    &quot;profiles&quot;: {</span></span>
<span class="line"><span>      &quot;www&quot;: {</span></span>
<span class="line"><span>         &quot;expiry&quot;: &quot;87600h&quot;,</span></span>
<span class="line"><span>         &quot;usages&quot;: [</span></span>
<span class="line"><span>            &quot;signing&quot;,</span></span>
<span class="line"><span>            &quot;key encipherment&quot;,</span></span>
<span class="line"><span>            &quot;server auth&quot;,</span></span>
<span class="line"><span>            &quot;client auth&quot;</span></span>
<span class="line"><span>        ]</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cat &gt; ca-csr.json &lt;&lt; EOF</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    &quot;CN&quot;: &quot;etcd CA&quot;,</span></span>
<span class="line"><span>    &quot;key&quot;: {</span></span>
<span class="line"><span>        &quot;algo&quot;: &quot;rsa&quot;,</span></span>
<span class="line"><span>        &quot;size&quot;: 2048</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    &quot;names&quot;: [</span></span>
<span class="line"><span>        {</span></span>
<span class="line"><span>            &quot;C&quot;: &quot;CN&quot;,</span></span>
<span class="line"><span>            &quot;L&quot;: &quot;Beijing&quot;,</span></span>
<span class="line"><span>            &quot;ST&quot;: &quot;Beijing&quot;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    ]</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 生成证书</span></span>
<span class="line"><span>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ls</span></span>
<span class="line"><span>ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>签发etcd https 证书</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;CN&quot;: &quot;etcd&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;hosts&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;192.168.10.14&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;192.168.10.15&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;192.168.10.16&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    ],</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;key&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        &quot;algo&quot;: &quot;rsa&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        &quot;size&quot;: 2048</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    },</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;names&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;C&quot;: &quot;CN&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;L&quot;: &quot;BeiJing&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;ST&quot;: &quot;BeiJing&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    ]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>hosts 为etcd的集群节点ip, 改成你实际的ip即可。</p></blockquote><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca=ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca-key=ca-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -config=ca-config.json</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -profile=www</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ls</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">pem</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">server-key.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  server.pem</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-etcd-集群搭建" tabindex="-1"><a class="header-anchor" href="#_1-2-etcd-集群搭建"><span>1.2/ etcd 集群搭建</span></a></h4><p>下载etcd二进制文件到三台事先准备好的机器，编写配置文件和启动管理文件。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 创建etcd目录</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/etcd/{bin,cfg,ssl}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 复制生成的证书到etcd证书目录</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/ssl/etcd/ca</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/etcd/ssl/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/ssl/etcd/server</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/etcd/ssl/</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 配置文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tar</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> zxvf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd-v3.4.9-linux-amd64.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd-v3.4.9-linux-amd64</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcdctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/etcd/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/etcd/cfg/etcd.conf</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">#[Member]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ETCD_NAME=&quot;etcd-1&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.10.14:2380&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.10.14:2379&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">#[Clustering]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.10.14:2380&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.10.14:2379&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.10.14:2380,etcd-2=https://192.168.10.15:2380,etcd-3=https://192.168.10.16:2380&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ETCD_NAME：节点名称，集群中唯一</li><li>ETCD_DATA_DIR：数据目录</li><li>ETCD_LISTEN_PEER_URLS：集群通信监听地址</li><li>ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址</li><li>ETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址</li><li>ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址</li><li>ETCD_INITIAL_CLUSTER：集群节点地址</li><li>ETCD_INITIAL_CLUSTER_TOKEN：集群Token</li><li>ETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 编写启动管理文件</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/etcd.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Etcd Server</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network.target</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network-online.target</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Wants=network-online.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Type=notify</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">EnvironmentFile=/opt/etcd/cfg/etcd.conf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/opt/etcd/bin/etcd </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--enable-v2 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--cert-file=/opt/etcd/ssl/server.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--key-file=/opt/etcd/ssl/server-key.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--peer-cert-file=/opt/etcd/ssl/server.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--peer-key-file=/opt/etcd/ssl/server-key.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--trusted-ca-file=/opt/etcd/ssl/ca.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--logger=zap</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=on-failure</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 启动</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> etcd</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>复制etcd文件（/opt/etcd/下的所有文件，service文件）到其他两个节点，并修改<code>/opt/etcd/cfg/etcd.conf</code>文件中ip为对应节点ip，启动即可。</p><p>最后，查看节点状态。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ETCDCTL_API</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> /opt/etcd/bin/etcdctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cacert=/opt/etcd/ssl/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cert=/opt/etcd/ssl/server.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --key=/opt/etcd/ssl/server-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --endpoints=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.10.14:2379,https://192.168.10.15:2379,https://192.168.10.16:2379</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> endpoint</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> health</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">https://192.168.10.14:2379</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> is</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> healthy:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> successfully</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> committed</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> proposal:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> took</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 12.762896ms</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">https://192.168.10.15:2379</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> is</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> healthy:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> successfully</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> committed</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> proposal:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> took</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 12.974284ms</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">https://192.168.10.16:2379</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> is</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> healthy:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> successfully</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> committed</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> proposal:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> took</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> =</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 12.996147ms</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，etcd集群搭建完成。</p><h3 id="_2-kubernetes-master-节点部署" tabindex="-1"><a class="header-anchor" href="#_2-kubernetes-master-节点部署"><span>2/ Kubernetes Master 节点部署</span></a></h3><h4 id="_2-1-签发证书" tabindex="-1"><a class="header-anchor" href="#_2-1-签发证书"><span>2.1/ 签发证书</span></a></h4><p>生成根证书</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/ssl/k8s/</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ca-config.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;signing&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;default&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;expiry&quot;: &quot;87600h&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    },</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;profiles&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;kubernetes&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         &quot;expiry&quot;: &quot;87600h&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         &quot;usages&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;signing&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;key encipherment&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;server auth&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;client auth&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        ]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ca-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;CN&quot;: &quot;kubernetes&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;key&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        &quot;algo&quot;: &quot;rsa&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        &quot;size&quot;: 2048</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    },</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;names&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;C&quot;: &quot;CN&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;L&quot;: &quot;Beijing&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;ST&quot;: &quot;Beijing&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;O&quot;: &quot;k8s&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;OU&quot;: &quot;System&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    ]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成证书</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -initca</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ca-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ca</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> -</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>签发apiserver的https证书</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/ssl/k8s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;CN&quot;: &quot;kubernetes&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;hosts&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;10.10.0.1&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;127.0.0.1&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;192.168.10.11&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;192.168.10.12&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;192.168.10.13&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;192.168.10.14&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;192.168.10.15&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;192.168.10.16&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;192.168.10.17&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;kubernetes&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;kubernetes.default&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;kubernetes.default.svc&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;kubernetes.default.svc.cluster&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;kubernetes.default.svc.cluster.local&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    ],</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;key&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        &quot;algo&quot;: &quot;rsa&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        &quot;size&quot;: 2048</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    },</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;names&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;C&quot;: &quot;CN&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;L&quot;: &quot;BeiJing&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;ST&quot;: &quot;BeiJing&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;O&quot;: &quot;k8s&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            &quot;OU&quot;: &quot;System&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    ]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>hosts字段中IP为所有Master/LB/VIP 的ip，需要访问apiserver 的节点ip 建议都写上。</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span># 生成证书</span></span>
<span class="line"><span>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-apiserver-部署" tabindex="-1"><a class="header-anchor" href="#_2-2-apiserver-部署"><span>2.2/ apiserver 部署</span></a></h4><p>可从这里 https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG 找到你需要的版本的二进制安装包。直接下载server包即可，其中包含有 <code>apiserver</code>、<code>controller manager</code>和<code>scheduler</code>的二进制文件。 <code>apiserver</code> 部署步骤如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 获取二进制文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://dl.k8s.io/v1.16.14/kubernetes-server-linux-amd64.tar.gz</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/{bin,cfg,ssl,logs}</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tar</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> zxvf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes-server-linux-amd64.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes/server/bin</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-apiserver</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-scheduler</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-controller-manager</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/bin</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 创建配置文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/ssl/k8s/ca</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/ssl/k8s/server</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/ssl/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/cfg/kube-apiserver.conf</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KUBE_APISERVER_OPTS=&quot;--logtostderr=false </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--v=2 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--log-dir=/opt/kubernetes/logs </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--etcd-servers=https://192.168.10.14:2379,https://192.168.10.15:2379,https://192.168.10.16:2379 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--bind-address=192.168.10.11 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--secure-port=6443 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--advertise-address=192.168.10.11 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--allow-privileged=true </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--service-cluster-ip-range=10.10.0.0/24 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--authorization-mode=RBAC,Node </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--enable-bootstrap-token-auth=true </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--token-auth-file=/opt/kubernetes/cfg/token.csv </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--service-node-port-range=30000-32767 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--tls-cert-file=/opt/kubernetes/ssl/server.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--client-ca-file=/opt/kubernetes/ssl/ca.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--etcd-cafile=/opt/etcd/ssl/ca.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--etcd-certfile=/opt/etcd/ssl/server.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--etcd-keyfile=/opt/etcd/ssl/server-key.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--audit-log-maxage=30 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--audit-log-maxbackup=3 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--audit-log-maxsize=100 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>logtostderr：启用日志</li><li>v：日志等级</li><li>log-dir：日志目录</li><li>etcd-servers：etcd集群地址</li><li>bind-address：监听地址</li><li>secure-port：https安全端口</li><li>advertise-address：集群通告地址</li><li>allow-privileged：启用授权</li><li>service-cluster-ip-range：Service虚拟IP地址段</li><li>enable-admission-plugins：准入控制模块</li><li>authorization-mode：认证授权，启用RBAC授权和节点自管理</li><li>enable-bootstrap-token-auth：启用TLS bootstrap机制</li><li>token-auth-file：bootstrap token文件</li><li>service-node-port-range：Service nodeport类型默认分配端口范围</li><li>kubelet-client-xxx：apiserver访问kubelet客户端证书</li><li>tls-xxx-file：apiserver https证书</li><li>etcd-xxxfile：连接Etcd集群证书</li><li>audit-log-xxx：审计日志</li></ul><p>Master apiserver启用TLS认证后，Node节点<code>kubelet</code>和<code>kube-proxy</code>要与<code>kube-apiserver</code>进行通信，必须使用CA签发的有效证书才可以，当Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，Kubernetes引入了<code>TLS bootstraping</code>机制来自动颁发客户端证书，<code>kubelet</code>会以一个低权限用户自动向<code>apiserver</code>申请证书，<code>kubelet</code>的证书由<code>apiserver</code>动态签署。所以强烈建议在Node上使用这种方式，目前主要用于<code>kubelet</code>，<code>kube-proxy</code>还是由我们统一颁发一个证书。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成一个随机token </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">head</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -c</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 16</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /dev/urandom</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> od</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -An</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -t</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> x</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> tr</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -d</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ebe4f1e22044e23638394dd24d4aff49</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 创建token 文件， 该文件在 apiserver 参数 token-auth-file 参数使用</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/cfg/token.csv</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ebe4f1e22044e23638394dd24d4aff49,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建服务管理配置文件</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kube-apiserver.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes API Server</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/opt/kubernetes/bin/kube-apiserver </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KUBE_APISERVER_OPTS</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=on-failure</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-apiserver</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-apiserver</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>授权kubelet-bootstrap 用户允许请求证书，kubelet使用该用户来请求apiserver证书，该用户稍后部署kubelet时会配置。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clusterrolebinding</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubelet-bootstrap</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--clusterrole=system:node-bootstrapper </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--user=kubelet-bootstrap</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-kube-controller-manager-部署" tabindex="-1"><a class="header-anchor" href="#_2-3-kube-controller-manager-部署"><span>2.3/ kube-controller-manager 部署</span></a></h4><p>创建配置文件</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/cfg/kube-controller-manager.conf</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--v=2 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--log-dir=/opt/kubernetes/logs </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--leader-elect=true </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--master=127.0.0.1:8080 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--bind-address=127.0.0.1 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--service-cluster-ip-range=10.10.0.0/24 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--root-ca-file=/opt/kubernetes/ssl/ca.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--experimental-cluster-signing-duration=87600h0m0s&quot;</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>master：通过本地端口8080连接apiserver。</li><li>leader-elect：当该组件启动多个时，自动选举（HA）</li><li>cluster-signing-cert-file/–cluster-signing-key-file：自动为kubelet颁发证书的CA，与apiserver保持一致</li></ul><p>启动管理配置文件</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kube-controller-manager.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes Controller Manager</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/opt/kubernetes/bin/kube-controller-manager </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KUBE_CONTROLLER_MANAGER_OPTS</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=on-failure</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-controller-manager</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-controller-manager</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4-kube-scheduler-部署" tabindex="-1"><a class="header-anchor" href="#_2-4-kube-scheduler-部署"><span>2.4/ kube-scheduler 部署</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/cfg/kube-scheduler.conf</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--v=2 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--log-dir=/opt/kubernetes/logs </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--leader-elect=true </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--master=127.0.0.1:8080 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--bind-address=127.0.0.1&quot;</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>master：通过本地端口8080连接apiserver。</li><li>leader-elect：当该组件启动多个时，自动选举（HA）</li></ul><p>启动管理配置文件</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kube-scheduler.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes Scheduler</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Documentation=https://github.com/kubernetes/kubernetes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/opt/kubernetes/bin/kube-scheduler </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KUBE_SCHEDULER_OPTS</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=on-failure</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-scheduler</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-scheduler</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-5-部署其他两个master节点" tabindex="-1"><a class="header-anchor" href="#_2-5-部署其他两个master节点"><span>2.5/ 部署其他两个Master节点</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 创建etcd 证书目录</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/etcd/ssl</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 复制 apiserver controller-manager scheduler 配置文件及二进制文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -r</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root@192.168.10.12:/opt</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 复制etcd 证书文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -r</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/etcd/ssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root@192.168.10.12:/opt/etcd</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 复制 systemd 管理文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kube</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root@192.168.10.12:/usr/lib/systemd/system</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 复制ctl 二进制文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/bin/kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  root@192.168.10.12:/usr/bin</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 修改配置文件为对应ip </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vi</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/cfg/kube-apiserver.conf</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">--bind-address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">192.168.10.12</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> \</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">--advertise-address=192.168.10.12 </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 启动</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-apiserver</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-controller-manager</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-scheduler</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-apiserver</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-controller-manager</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-scheduler</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，Master节点部署完成。</p><h3 id="_3-kubernetes-node-节点部署" tabindex="-1"><a class="header-anchor" href="#_3-kubernetes-node-节点部署"><span>3/ Kubernetes Node 节点部署</span></a></h3><p>创建目标，并复制组件二进制文件。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 创建kubernetes目录</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/{bin,cfg,ssl,logs}</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 复制二进制文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/kubernetes/server/bin/kubelet</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  root@192.168.10.14:/opt/kubernetes/bin</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/kubernetes/server/bin/kube-proxy</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  root@192.168.10.14:/opt/kubernetes/bin</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /root/kubernetes/server/bin/kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  root@192.168.10.14:/bin/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">chmod</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> +x</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/bin/</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">chmod</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> +x</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /bin/kubectl</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 复制根证书</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">scp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/ssl/ca.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  root@192.168.10.14:/opt/kubernetes/ssl</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-kubelet-部署" tabindex="-1"><a class="header-anchor" href="#_3-1-kubelet-部署"><span>3.1/ kubelet 部署</span></a></h4><p>创建配置文件</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; EOF</span></span>
<span class="line"><span>KUBELET_OPTS=&quot;--logtostderr=false \\</span></span>
<span class="line"><span>--v=2 \\</span></span>
<span class="line"><span>--log-dir=/opt/kubernetes/logs \\</span></span>
<span class="line"><span>--hostname-override=10-14-node \\</span></span>
<span class="line"><span>--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\</span></span>
<span class="line"><span>--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\</span></span>
<span class="line"><span>--config=/opt/kubernetes/cfg/kubelet-config.yml \\</span></span>
<span class="line"><span>--cert-dir=/opt/kubernetes/ssl \\</span></span>
<span class="line"><span>--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>hostname-override：显示名称，集群中唯一</li><li>network-plugin：启用CNI</li><li>kubeconfig：自动生成的配置文件，后面用于连接apiserver</li><li>bootstrap-kubeconfig：首次启动向apiserver申请证书</li><li>config：配置参数文件</li><li>cert-dir：kubelet证书生成目录</li><li>pod-infra-container-image：管理Pod网络容器的镜像</li></ul><p>配置参数文件。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/cfg/kubelet-config.yml</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: KubeletConfiguration</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">address: 0.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">port: 10250</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">readOnlyPort: 10255</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cgroupDriver: systemd</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">clusterDNS:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">- 10.10.0.2</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">clusterDomain: cluster.local </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">failSwapOn: false</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">authentication:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  anonymous:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    enabled: false</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  webhook:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    cacheTTL: 2m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    enabled: true</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  x509:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    clientCAFile: /opt/kubernetes/ssl/ca.pem</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">authorization:  </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  mode: Webhook</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  webhook:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    cacheAuthorizedTTL: 5m0s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    cacheUnauthorizedTTL: 30s</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">evictionHard:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  imagefs.available: 15%</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  memory.available: 100Mi</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  nodefs.available: 10%</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  nodefs.inodesFree: 5%</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">maxOpenFiles: 1000000</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">maxPods: 110</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>cgroupDriver: 需要与Docker的cgroup启动一致，这里都是用systemd。</li><li>clusterDNS: DNS 服务器地址，用来做服务名称和ip的解析用。service启动会创建一条服务名和ip的解析，直接使用service名称就能访问服务，以达到服务发现的效果。这里先填上ip,后边会部署这个DNS服务。</li></ul><p>生成 kubelet bootstrap kubeconfig 配置文件, 用来申请apiserver 证书。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-cluster</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --certificate-authority=/opt/kubernetes/ssl/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --server=https://192.168.10.12:6443</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --kubeconfig=bootstrap.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-credentials</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kubelet-bootstrap</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --token=ebe4f1e22044e23638394dd24d4aff49</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --kubeconfig=bootstrap.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --cluster=kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --user=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kubelet-bootstrap</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --kubeconfig=bootstrap.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> use-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=bootstrap.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> bootstrap.kubeconfig</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/cfg</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建system服务管理文件。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kubelet.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes Kubelet</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=docker.service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/opt/kubernetes/bin/kubelet </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KUBELET_OPTS</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=on-failure</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubelet</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubelet</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动之后，在Master节点可以看到申请，需要执行如下命令来接受。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看node 加入申请</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@10-11-master</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># kubectl get csr</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                                                   AGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   REQUESTOR</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           CONDITION</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">node-csr-zXbvV_-slQhtuuKZddLIl9H4mKEfOhTkB-8TtaW2Nf8</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   36s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   kubelet-bootstrap</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Pending</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 接受申请</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> certificate</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> approve</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node-csr-zXbvV_-slQhtuuKZddLIl9H4mKEfOhTkB-8TtaW2Nf8</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看node </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@10-11-master</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># kubectl get node</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                     STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     ROLES</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    AGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    VERSION</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">75-33-65-shx-node</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        NotReady</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">non</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">e</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   1s</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     v1.16.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>节点状态为 NotReady，稍后等kubelet初始化好后，变为 Ready。有些kubelet配置了cni(容器网络接口)插件，当插件安装之前，不会变为Ready。</p></blockquote><h4 id="_3-2-kube-proxy-部署" tabindex="-1"><a class="header-anchor" href="#_3-2-kube-proxy-部署"><span>3.2/ kube-proxy 部署</span></a></h4><p>证书签发</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/ssl</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;hosts&quot;: [],</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;key&quot;: {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;algo&quot;: &quot;rsa&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    &quot;size&quot;: 2048</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  },</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  &quot;names&quot;: [</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;C&quot;: &quot;CN&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;O&quot;: &quot;k8s&quot;,</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      &quot;OU&quot;: &quot;System&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  ]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成证书</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cfssl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gencert</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca=ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ca-key=ca-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -config=ca-config.json</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -profile=kubernetes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy-csr.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> cfssljson</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -bare</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ls</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">*</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">pem</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kube-proxy-key.pem</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  kube-proxy.pem</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成 kubeconfig 文件</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-cluster</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --certificate-authority=/opt/kubernetes/ssl/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --server=https://192.168.10.12:6443</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --kubeconfig=kube-proxy.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-credentials</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --client-certificate=./kube-proxy.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --client-key=./kube-proxy-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --embed-certs=true</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --kubeconfig=kube-proxy.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --cluster=kubernetes</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --user=kube-proxy</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --kubeconfig=kube-proxy.kubeconfig</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> use-context</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --kubeconfig=kube-proxy.kubeconfig</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy.kubeconfig</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /opt/kubernetes/cfg/</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>环境变量配置文件</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span># 环境变量配置文件</span></span>
<span class="line"><span>cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; EOF</span></span>
<span class="line"><span>KUBE_PROXY_OPTS=&quot;--logtostderr=false \\</span></span>
<span class="line"><span>--v=2 \\</span></span>
<span class="line"><span>--log-dir=/opt/kubernetes/logs \\</span></span>
<span class="line"><span>--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 配置文件</span></span>
<span class="line"><span>cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; EOF</span></span>
<span class="line"><span>kind: KubeProxyConfiguration</span></span>
<span class="line"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span>
<span class="line"><span>bindAddress: 0.0.0.0</span></span>
<span class="line"><span>metricsBindAddress: 0.0.0.0:10249</span></span>
<span class="line"><span>clientConnection:</span></span>
<span class="line"><span>  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig</span></span>
<span class="line"><span>hostnameOverride: 10-14-node</span></span>
<span class="line"><span>clusterCIDR: 10.10.0.0/16</span></span>
<span class="line"><span>EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>systemd 服务管理脚本</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /usr/lib/systemd/system/kube-proxy.service</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Description=Kubernetes Proxy</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">After=network.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ExecStart=/opt/kubernetes/bin/kube-proxy </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">KUBE_PROXY_OPTS</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Restart=on-failure</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">LimitNOFILE=65536</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-proxy</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，Node 节点部署完成。其他Node 部署相同，修改对应ip和host即可。</p><h3 id="_4-网络插件部署" tabindex="-1"><a class="header-anchor" href="#_4-网络插件部署"><span>4/ 网络插件部署</span></a></h3><p>安装完Node节点组件之后，Pod内容器是可以通信的，但是Pod之间是无法通信的，这就需要CNI网络插件了。常用的CNI插件有Calico、flannel、Terway、Weave Net 以及 Contiv。这里选用常用的Flannel，如何选择CNI插件，大家可参考这篇文章 <a href="https://www.kubernetes.org.cn/6908.html" target="_blank" rel="noopener noreferrer">理解 CNI 和 CNI 插件</a>。</p><p>CNI插件的安装方式有两种：</p><ul><li>ETCD 方式。这种方式就是利用etcd存储网络配置信息，并且利用dockerd启动参数<code>--bip</code>来指定每个节点的网段信息。</li><li>CNI插件方式。这种方式是利用cni插件，并且将网络配置信息存储在kubernetes api中，Kubulet找到对应的cni插件，有插件分配节点IP网段。</li></ul><p>CNI 插件主要部署在有Pod 调度的节点，常部署在Node节点。</p><h4 id="_4-1-cni方式安装" tabindex="-1"><a class="header-anchor" href="#_4-1-cni方式安装"><span>4.1/ CNI方式安装</span></a></h4><p>CNI插件方式，首先需要在Master 各组件增加一些参数。</p><p>1/ 修改controller参数</p><p>在kube-controller-manager启动脚本中加入下边两个参数：</p><ul><li><code>--allocate-node-cidrs=true</code> 节点允许自动分配网段。</li><li><code>--cluster-cidr=10.10.0.0/16</code> 为我们指定的集群的网段，这样每一个docker节点都会分别使用自网段10.10.0.0/24，10.10.1.0/24作为每个pod的网段，可以通过<code>kubectl get pod &lt;pod_name&gt; -o yaml</code>命令查看<code>spec.podCIDR</code>字段。</li></ul><p>如果不配置该步骤可能会<code>flannel</code>出现<code>error registering network: failed to acquire lease: node &quot;192.168.10.14&quot; pod</code>的错误</p><p>2/ 修改kubelet参数</p><p>指定kubelet网络插件，在kubelet中指定如下三个参数：</p><ul><li><code>--network-plugin=cni</code> 网络插件使用cni，必须添加，否则默认走docker自己的网络。</li><li><code>--cni-conf-dir=/etc/cni/net.d</code> cni配置文件 ，默认</li><li><code>--cni-bin-dir=/opt/cni/bin</code> cni可执行文件，默认</li></ul><p>这样在kublet启动的时候，就会去/etc/cni/net.d目录查找配置文件，并解析，使用相应的插件配置网络</p><p>3/ 下载cni依赖插件</p><p>下载cni官方提供的组件：<a href="https://github.com/containernetworking/plugins/releases/download/v0.7.1/cni-plugins-amd64-v0.7.1.tgz" target="_blank" rel="noopener noreferrer">cni-plugins-amd64-v0.7.1.tgz</a> ，并将可执行文件放在/opt/cni/bin目录。</p><p>这里不单单只会用到flannel文件，也会用到brage用来创建网桥以及host-local用来分配ip。</p><p>这一步不是必须的，当使用yum 安装 kubelet时，会自动下载依赖的<code>kubernetes-cni</code>包，并放置到相应位置。</p><p>4/ 安装flanneld组件</p><p>flannel组件直接以<code>daemonset</code>的方式安装在k8s集群中：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span>
<span class="line"><span>kubectl apply -f kube-flannel.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>其中<code>kube-flannel-cfg</code> configmap 中的 Network 字段需要与<code>--cluster-cidr</code>配置的网段一致。</p><p>这一步主要是安装了<code>flanneld</code>以及将<code>flannel</code>配置文件写入<code>/etc/cni/net.d</code>目录。</p><p>查看<code>kube-flannel.yml</code>中<code>flanneld</code>的启动参数为：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">--ip-masq</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> :</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 需要为其配置SNAT</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">--kube-subnet-mgr</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> :</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 代表其使用kube类型的subnet-manager。该类型有别于使用etcd的local-subnet-mgr类型，使用kube类型后，flannel上各Node的IP子网分配均基于K8S</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Node的</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">`</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">spec.podCIDR</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">`</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">属性</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-etcd-方式" tabindex="-1"><a class="header-anchor" href="#_4-2-etcd-方式"><span>4.2/ ETCD 方式</span></a></h4><p>ETCD 方式安装<code>Flannel</code>，参数无需修改，可保持之前步骤中的参数。</p><p>1/ 创建Flannel使用的网段</p><p>该方式，网段信息是保存在ETCD的，需要我们手动的添加</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@10-14-node </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ETCDCTL_API</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> etcdctl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --ca-file=/usr/local/kubernetes/etcd/ssl/ca.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --cert-file=/usr/local/kubernetes/etcd/ssl/server.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --key-file=/usr/local/kubernetes/etcd/ssl/server-key.pem</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --endpoints=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://192.168.10.14:2379,https://192.168.10.15:2379,https://192.168.10.16:2379</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> set</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /coreos.com/network/config</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{&quot;Network&quot;:&quot;10.10.0.0/16&quot;,&quot;Backend&quot;:{&quot;Type&quot;:&quot;vxlan&quot;}}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;Network&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;10.10.0.0/16&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">,</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;Backend&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Type</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;:&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vxlan</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;}}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">[root@10-14-node ~]# ETCDCTL_API=2 etcdctl --ca-file=/usr/local/kubernetes/etcd/ssl/ca.pem --cert-file=/usr/local/kubernetes/etcd/ssl/server.pem --key-file=/usr/local/kubernetes/etcd/ssl/server-key.pem --endpoints=https://192.168.10.14:2379,https://192.168.10.15:2379,https://192.168.10.16:2379 get /coreos.com/network/config</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">{&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Network</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;:&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">10.10.0.0/16</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;,&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Backend</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;:{&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Type</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;:&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vxlan</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;}}</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">[root@10-15-node ~]# ETCDCTL_API=2 etcdctl --ca-file=/usr/local/kubernetes/etcd/ssl/ca.pem --cert-file=/usr/local/kubernetes/etcd/ssl/server.pem --key-file=/usr/local/kubernetes/etcd/ssl/server-key.pem --endpoints=https://192.168.10.14:2379,https://192.168.10.15:2379,https://192.168.10.16:2379 get /coreos.com/network/config</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">{&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Network</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;:&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">10.10.0.0/16</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;,&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Backend</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;:{&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Type</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;:&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vxlan</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;}}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>使用该方式安装时，flannel仅支持etcd2版本的api，针对etcd 3+ 需要做下兼容。在etcd的启动时添加参数<code>--enable-v2</code> 做兼容。etcdctl 执行时，需要加 <code>ETRCDCTL_API=2</code> 的环境变量。 不做兼容的话，汇报如下错误：<code>Couldn&#39;t fetch network config: client: response is invalid json. The endpoint is probably not valid etcd cluster endpoint. timed out</code>, 可见这个<a href="https://github.com/coreos/flannel/issues/1191" target="_blank" rel="noopener noreferrer">issue</a>。</p></blockquote><p>2/ 安装Flannel</p><p>下载二进制文件，https://github.com/coreos/flannel/releases , 这里选用 0.11。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span></span>
<span class="line"><span>tar zxvf flannel-v0.11.0-linux-amd64.tar.gz</span></span>
<span class="line"><span>mv flanneld mk-docker-opts.sh /opt/kubernetes/bin/</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 配置文件</span></span>
<span class="line"><span>cat &gt; /opt/kubernetes/cfg/flannel.conf &lt;&lt; EOF</span></span>
<span class="line"><span>FLANNEL_OPTIONS=&quot;--etcd-endpoints=https://192.168.10.14:2379,https://192.168.10.14:2379,https://192.168.10.14:2379 \\</span></span>
<span class="line"><span>--etcd-cafile=/opt/etcd/ssl/ca.pem \\</span></span>
<span class="line"><span>--etcd-certfile=/opt/etcd/ssl/server.pem \\</span></span>
<span class="line"><span>--etcd-keyfile=/opt/etcd/ssl/server-key.pem&quot;</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 添加启动文件</span></span>
<span class="line"><span>cat &gt; /usr/lib/systemd/system/flanneld.service &lt;&lt; EOF</span></span>
<span class="line"><span>[Unit]</span></span>
<span class="line"><span>Description=Flanneld overlay address etcd agent</span></span>
<span class="line"><span>After=network-online.target network.target</span></span>
<span class="line"><span>Before=docker.service</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[Service]</span></span>
<span class="line"><span>Type=notify</span></span>
<span class="line"><span>EnvironmentFile=/usr/local/kubernetes/cfg/flannel.conf</span></span>
<span class="line"><span>ExecStart=/usr/local/kubernetes/bin/flanneld --ip-masq $FLANNEL_OPTIONS</span></span>
<span class="line"><span>ExecStartPost=/usr/local/kubernetes/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/subnet.env</span></span>
<span class="line"><span>Restart=on-failure</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[Install]</span></span>
<span class="line"><span>WantedBy=multi-user.target</span></span>
<span class="line"><span>EOF</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 启动 </span></span>
<span class="line"><span>systemctl daemon-reload </span></span>
<span class="line"><span>systemctl start flanneld</span></span>
<span class="line"><span>systemctl enable flanneld</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动之后会在<code>/run/flannel/subnet.env</code> 生成一个子网描述文件，内容如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">DOCKER_OPT_BIP</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--bip=10.10.101.1/24</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">DOCKER_OPT_IPMASQ</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--ip-masq=false</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">DOCKER_OPT_MTU</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--mtu=1450</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">DOCKER_NETWORK_OPTIONS</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> --bip=10.10.101.1/24 --ip-masq=false --mtu=1450</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们需要将它配置为Docker 的环境变量，以供Docker 分配ip使用。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">EnvironmentFile</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/run/flannel/subnet.env</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ExecStart</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/usr/bin/dockerd</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> -H</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> fd://</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --containerd=/run/containerd/containerd.sock</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> $DOCKER_NETWORK_OPTIONS</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启Docker，以加载新的配置。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>systemctl daemon-reload</span></span>
<span class="line"><span>systemctl restart docker</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，Flannel 插件边安装完成了。安装完成后，可通过 <code>ip a </code>看到，自动创建了一个<code>flannel.1</code> 类似名称的虚拟网卡出现，主要用来做vxlan报文的处理，封包和解包。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@10-14-node </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># ip a</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> lo:</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">LOOPBACK,UP,LOWER_U</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">P</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mtu</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 65536</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> qdisc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> noqueue</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> state</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> UNKNOWN</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> group</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> qlen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    link/loopback</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00:00:00:00</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> brd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 00:00:00:00:00:00</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    inet</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1/8</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scope</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> host</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> lo</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       valid_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> preferred_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    inet6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ::1/128</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scope</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> host</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       valid_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> preferred_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">2:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> eth0:</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">P</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mtu</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1500</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> qdisc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mq</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> state</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> UP</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> group</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> qlen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    link/ether</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> c4:b8:b4:91:4e:99</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> brd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ff:ff:ff:ff:ff:ff</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    inet</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.10.14/24</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> brd</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 192.168.10.255</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scope</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> global</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       valid_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> preferred_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">3:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> eth1:</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">BROADCAST,MULTICAS</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">T</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mtu</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1500</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> qdisc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> noop</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> state</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> DOWN</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> group</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> qlen</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1000</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    link/ether</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> c4:b8:b4:91:4e:9a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> brd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ff:ff:ff:ff:ff:ff</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">4:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker0:</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">NO-CARRIER,BROADCAST,MULTICAST,U</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">P</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mtu</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1500</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> qdisc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> noqueue</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> state</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> DOWN</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> group</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    link/ether</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 02:42:26:57:30:53</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> brd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ff:ff:ff:ff:ff:ff</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    inet</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10.10.101.1/24</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> brd</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10.10.101.255</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scope</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> global</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker0</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       valid_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> preferred_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    inet6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> fe80::42:26ff:fe57:3053/64</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scope</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> link</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       valid_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> preferred_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">9:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> flannel.1:</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">BROADCAST,MULTICAST,UP,LOWER_U</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">P</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mtu</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1450</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> qdisc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> noqueue</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> state</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> UNKNOWN</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> group</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> default</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    link/ether</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 2a:3c:d8:f4:f9:aa</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> brd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ff:ff:ff:ff:ff:ff</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    inet</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10.10.101.0/32</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scope</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> global</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> flannel.1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       valid_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> preferred_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    inet6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> fe80::283c:d8ff:fef4:f9aa/64</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scope</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> link</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       valid_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> preferred_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在看路由：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>[root@75-33-65-shx-node data0]# route</span></span>
<span class="line"><span>Kernel IP routing table</span></span>
<span class="line"><span>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span></span>
<span class="line"><span>default         gateway         0.0.0.0         UG    0      0        0 eth0</span></span>
<span class="line"><span>10.10.15.0      10.10.15.0      255.255.255.0   UG    0      0        0 flannel.1</span></span>
<span class="line"><span>10.10.53.0      10.10.53.0      255.255.255.0   UG    0      0        0 flannel.1</span></span>
<span class="line"><span>10.10.66.0      10.10.66.0      255.255.255.0   UG    0      0        0 flannel.1</span></span>
<span class="line"><span>10.10.70.0      10.10.70.0      255.255.255.0   UG    0      0        0 flannel.1</span></span>
<span class="line"><span>10.10.96.0      10.10.96.0      255.255.255.0   UG    0      0        0 flannel.1</span></span>
<span class="line"><span>10.10.101.0     0.0.0.0         255.255.255.0   U     0      0        0 docker0</span></span>
<span class="line"><span>...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了自身 <code>10.10.101.0</code>的包，其他<code>10.10.0.0/16 </code>网段的包都走 <code>flannel.1</code>虚拟网卡。</p><h3 id="_5-dns服务插件部署" tabindex="-1"><a class="header-anchor" href="#_5-dns服务插件部署"><span>5/ DNS服务插件部署</span></a></h3><p>在K8S中，DNS服务主要用来解析Service 名称和ip。当有新的service 时，无需知道它的ip直接使用名称即可调用。K8S 目标有两种常用的DNS方案，<code>kube-dns</code> 和<code>CoreDNS</code>。<code>CoreDNS</code>从1.11起，使用<code>kubeadm</code> 安装K8S时，是默认安装的。这里也选择安装 <code>CoreDNS</code>，因为<code>CoreDNS</code>服务是以pod的形式运行，所以下边操作只需在一台Master上操作即可。</p><p>下面开始安装：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 下载 CoreDNS 项目</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">git</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://github.com/coredns/deployment.git</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> coredns/deployment/kubernetes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>找到 <code>deploy.sh</code>， 修改如下配置:</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">111 if [[ -z $CLUSTER_DNS_IP ]]</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> then</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">112   # Default IP to kube-dns IP</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">113   # CLUSTER_DNS_IP</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">$(</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kubectl get service --namespace kube-system kube-dns -o jsonpath=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">&quot;{.spec.clusterIP}&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">114   CLUSTER_DNS_IP</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">=10.10.0.2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>默认情况下 <code>CLUSTER_DNS_IP</code> 是自动获取<code>kube-dns</code>的集群ip的，但是由于没有部署kube-dns所以只能手动指定一个集群ip。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 生成 发布文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> deploy.sh</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> coredns.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 引用yaml </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> coredns.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> svc,pods</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> coredns</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pod/coredns-759df9d7b-gzj5b</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          22h</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> busybox.yml</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apiVersion: v1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">kind: Pod</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">metadata:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  name: busybox</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  namespace: default</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">spec:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  containers:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  - name: busybox</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    image: busybox:1.28.4</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    command:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - sleep</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      - &quot;3600&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    imagePullPolicy: IfNotPresent</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  restartPolicy: Always</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> busybox.yml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> exec</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> busybox</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nslookup</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Server:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    10.10.0.2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Address</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 1:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10.10.0.2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-dns.kube-system.svc.cluster.local</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      kubernetes</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Address</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 1:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10.10.0.1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes.default.svc.cluster.local</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>出现以上信息，说明解析正常。</p><h3 id="_6-dashboard-部署" tabindex="-1"><a class="header-anchor" href="#_6-dashboard-部署"><span>6/ Dashboard 部署</span></a></h3><p>K8S 官方提供了一个web的操作界面叫Dashboard，可以满足基本的资源的创建、配置和修改。下面说下如何安装：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">wget</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta8/aio/deploy/recommended.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 下载好配置文件，修改service 访问策略为 NodePort，可直接通过node 的ip访问。</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">spec:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  ports:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> port:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 443</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      targetPort:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8443</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      nodePort:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 30001</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # 新增</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  type</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> NodePort</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   # 新增</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apply</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> recommended.yaml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pods,svc</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes-dashboard</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                                             READY</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    RESTARTS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   AGE</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pod/dashboard-metrics-scraper-76585494d8-hbjj4</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          8d</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pod/kubernetes-dashboard-5996555fd8-j5kq9</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          8d</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                                TYPE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        CLUSTER-IP</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     EXTERNAL-IP</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   PORT</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">S</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         AGE</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">service/dashboard-metrics-scraper</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   ClusterIP</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   10.10.130.25</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">non</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">e</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        8000/TCP</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        8d</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">service/kubernetes-dashboard</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        NodePort</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    10.10.32.39</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">non</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">e</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        443:30001/TCP</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   8d</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可通过 <code>https://&lt;node_ip&gt;:30001</code> 来访问，系统提供了两种任务方式，我们常用token认证方式，下边我们来生成token。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 创建service admin 账户 dashboard-admin </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> serviceaccount</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dashboard-admin</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 绑定集群默认管理员角色 cluster-admin </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clusterrolebinding</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dashboard-admin</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --clusterrole=cluster-admin</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --serviceaccount=kube-system:dashboard-admin</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看登录 token </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> describe</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secrets</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> $(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kube-system</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secret</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> awk</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/dashboard-admin/{print $1}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可使用上边输出的token ，登录dashboard。</p><h3 id="高可用架构" tabindex="-1"><a class="header-anchor" href="#高可用架构"><span>高可用架构</span></a></h3><p>到这里，我们所有节点组件完成。我们的架构如下图：</p><p><img src="/imgs/k8s/k8s-ha.png" alt=""></p><p>从图中我们可以看出一个问题，<code>controller-manager</code> 和<code>scheduler</code>可通过<code>etcd</code>间接的通信实现互为备份高可用，而<code>apiserver</code>则没有。架构中所有的Node都是连接的一台Master 的apiserver，其他两台并没有利用起来，连接的这台一旦出现故障，整个系统便无法使用。这个问题，常用的解决方案是使用 <code>nginx</code> 和 <code>keeplive</code> 实现，架构如下：</p><p><img src="/imgs/k8s/k8s-ha-2.png" alt=""></p><p>因为需要单独申请VIP，我并没有做具体搭建，仅使用nginx做了负载均衡。需要注意的是，这里Nginx 用来做四层的负载均衡使用 <code>stream</code>配置段，和<code>http</code>略有不同。</p><p>这里简单说下搭建步骤，最少使用两台机器互为主备。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 安装nginx 和 keepalive。</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> epel-release</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># nginx 配置文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/nginx/nginx.conf</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;EOF&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">user nginx;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">worker_processes auto;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">error_log /var/log/nginx/error.log;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">pid /run/nginx.pid;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">include /usr/share/nginx/modules/*.conf;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">events {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    worker_connections 1024;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"># 四层负载均衡，为两台Master apiserver组件提供负载均衡</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">stream {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    log_format  main  &#39;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    access_log  /var/log/nginx/k8s-access.log  main;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    upstream k8s-apiserver {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       server 192.168.10.14:6443;   # Master1 APISERVER IP:PORT</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       server 192.168.10.15:6443;   # Master2 APISERVER IP:PORT</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       server 192.168.10.16:6443;   # Master2 APISERVER IP:PORT</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    server {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       listen 6443;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       proxy_pass k8s-apiserver;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">http {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    access_log  /var/log/nginx/access.log  main;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    sendfile            on;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    tcp_nopush          on;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    tcp_nodelay         on;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    keepalive_timeout   65;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    types_hash_max_size 2048;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    include             /etc/nginx/mime.types;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    default_type        application/octet-stream;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    server {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        listen       80 default_server;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        server_name  _;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        location / {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    }</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># keepalive 主机配置文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/keepalived/keepalived.conf</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">global_defs { </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   notification_email { </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     acassen@firewall.loc </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     failover@firewall.loc </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     sysadmin@firewall.loc </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   } </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   notification_email_from Alexandre.Cassen@firewall.loc  </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   smtp_server 127.0.0.1 </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   smtp_connect_timeout 30 </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   router_id NGINX_MASTER</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">} </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vrrp_script check_nginx {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    script &quot;/etc/keepalived/check_nginx.sh&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vrrp_instance VI_1 { </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    state MASTER </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    interface ens33</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    priority 100    # 优先级，备服务器设置 90 </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    advert_int 1    # 指定VRRP 心跳包通告间隔时间，默认1秒 </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    authentication { </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        auth_type PASS      </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        auth_pass 1111 </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    }  </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    # 虚拟IP</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    virtual_ipaddress { </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        192.168.31.88/24</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    } </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    track_script {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        check_nginx</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    } </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># nginx 检测脚本，主备都需要有</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/keepalived/check_nginx.sh</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;EOF&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">count=$(ps -ef |grep nginx |egrep -cv &quot;grep|$$&quot;)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">if [ &quot;$count&quot; -eq 0 ];then</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    exit 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">else</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    exit 0</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">fi</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">chmod</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> +x</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/keepalived/check_nginx.sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># keepalive 备机配置文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cat</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/keepalived/keepalived.conf</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">global_defs { </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   notification_email { </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     acassen@firewall.loc </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     failover@firewall.loc </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     sysadmin@firewall.loc </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   } </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   notification_email_from Alexandre.Cassen@firewall.loc  </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   smtp_server 127.0.0.1 </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   smtp_connect_timeout 30 </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   router_id NGINX_BACKUP</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">} </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vrrp_script check_nginx {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    script &quot;/etc/keepalived/check_nginx.sh&quot;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vrrp_instance VI_1 { </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    state BACKUP </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    interface ens33</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    priority 90</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    advert_int 1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    authentication { </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        auth_type PASS      </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        auth_pass 1111 </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    }  </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    virtual_ipaddress { </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        192.168.31.88/24</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    } </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    track_script {</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        check_nginx</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    } </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 启动，并设置开机启动</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> enable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># ip a ,可以看到 vip 已经绑定到网卡上 </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">inet</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.31.88/24</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scope</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> global</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secondary</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ens33</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    valid_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> preferred_lft</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> forever</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下里，将所有Node节点改为链接 VIP 的<code>apiserver</code>，重启 <code>kubelet</code> 和 <code>kube-proxy</code> 即可。</p><p>至此，一个高可用的K8S集群便搭建完成了，尽情享用吧。</p><h2 id="扩展阅读" tabindex="-1"><a class="header-anchor" href="#扩展阅读"><span>扩展阅读</span></a></h2><ul><li><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/" target="_blank" rel="noopener noreferrer">1/ 通过 Kubeadm 安装 K8S 与高可用</a></li><li><a href="https://www.kubernetes.org.cn/docs" target="_blank" rel="noopener noreferrer">2/ Kubernetes中文文档</a></li><li><a href="https://draveness.me/dns-coredns/" target="_blank" rel="noopener noreferrer">3/ 详解 DNS 与 CoreDNS 的实现原理</a></li><li><a href="https://www.cnblogs.com/goldsunshine/p/10740928.html" target="_blank" rel="noopener noreferrer">4/ Flannel网络</a></li></ul></div><!----><!----><div class="vp-doc-copyright" data-v-f3eb9d47><h2 id="doc-copyright" tabindex="-1" class="vp-doc-header" data-v-8d0e6831><a href="#doc-copyright" class="header-anchor" data-v-8d0e6831><span data-v-8d0e6831><!--[-->版权所有<!--]--></span></a></h2><div class="hint-container tip copyright-container" data-v-bf7f7c64><p data-v-bf7f7c64><span data-v-bf7f7c64>版权归属：</span><a class="vp-link link no-icon" href="https://github.com/pylixm" target="_blank" rel="noreferrer" data-v-bf7f7c64><!--[-->pylixm<!--]--><!----></a></p><!----><p data-v-bf7f7c64><span data-v-bf7f7c64>许可证：</span><a class="vp-link link no-icon" href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noreferrer" data-v-bf7f7c64><!--[-->署名 4.0 国际 (CC-BY-4.0)<!--]--><!----></a><!--[--><span class="vpi-license-cc" data-v-bf7f7c64></span><span class="vpi-license-by" data-v-bf7f7c64></span><!--]--></p></div></div></div></main><footer class="vp-doc-footer" data-v-f3eb9d47 data-v-39887f7c><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-39887f7c><span class="contributors-label" data-v-39887f7c>贡献者: </span><span class="contributors-info" data-v-39887f7c><!--[--><!--[--><span class="contributor" data-v-39887f7c>pylixm</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-39887f7c><div class="pager" data-v-39887f7c><a class="vp-link link pager-link prev" href="/pages/2af80a/" data-v-39887f7c><!--[--><span class="desc" data-v-39887f7c>上一页</span><span class="title" data-v-39887f7c>Kubernetes 学习笔记 - 常用命令大全</span><!--]--><!----></a></div><div class="pager" data-v-39887f7c><a class="vp-link link pager-link next" href="/pages/8f4685/" data-v-39887f7c><!--[--><span class="desc" data-v-39887f7c>下一页</span><span class="title" data-v-39887f7c>Kubernetes 学习笔记-基础篇</span><!--]--><!----></a></div></nav></footer><div id="comment" class="giscus-wrapper input-top vp-comment" vp-comment style="display:block;" data-v-f3eb9d47><div style="display: flex;align-items: center;justify-content: center;height: 96px"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);--icon-size: 48px;display: inline-block;width: var(--icon-size);height: var(--icon-size);background-color: currentcolor;-webkit-mask-image: var(--loading-icon);mask-image: var(--loading-icon)"></span></div></div><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button type="button" class="vp-back-to-top" aria-label="back to top" data-v-cb0e7d0c style="display:none;" data-v-4667130d><span class="percent" data-allow-mismatch data-v-4667130d>0%</span><span class="show icon vpi-back-to-top" data-v-4667130d></span><svg aria-hidden="true" data-v-4667130d><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-4667130d></circle></svg></button><footer class="vp-footer" vp-footer data-v-cb0e7d0c data-v-cb5be875><!--[--><div class="container" data-v-cb5be875><p class="message" data-v-cb5be875>Power by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></p><p class="copyright" data-v-cb5be875>CC BY-NC-SA 4.0</p></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-DdES4ywf.js" defer></script></body></html>