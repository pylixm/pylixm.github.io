import{_ as i,c as a,a as n,o as e}from"./app-Cpl7-wzY.js";const l={};function t(h,s){return e(),a("div",null,[...s[0]||(s[0]=[n(`<p>Ansible 是自动化运维领域一款常用的服务器集群管理工具，他有丰富的文档和活跃的社区。</p><p>与同类型的竞品开源工具SaltStack/Puppet 相比，各有特色。可参考：</p><ul><li>https://www.edureka.co/blog/chef-vs-puppet-vs-ansible-vs-saltstack/</li><li>https://www.educba.com/saltstack-vs-ansible/</li></ul><p>本文旨在让读者快速掌握或回顾 Ansible 的一些概念和用法，所以并不会涉及细节的东西。如想进一步掌握，可阅读 Ansible 的<a href="https://docs.ansible.com/ansible/latest/index.html" target="_blank" rel="noopener noreferrer">官方文档</a>。</p><h2 id="ansible的介绍" tabindex="-1"><a class="header-anchor" href="#ansible的介绍"><span>Ansible的介绍</span></a></h2><p>Ansible是一款简单的运维自动化工具，只需要使用ssh协议连接就可以来进行系统管理，自动化执行命令，部署等任务。</p><h3 id="特点" tabindex="-1"><a class="header-anchor" href="#特点"><span>特点</span></a></h3><ul><li>1、ansible不需要单独安装客户端，也不需要启动任何服务</li><li>2、ansible是python中的一套完整的自动化执行任务模块</li><li>3、ansible playbook 采用yaml配置，对于自动化任务执行过程一目了然</li><li>3、ansible 执行任务时幂等的。</li></ul><h3 id="重要概念" tabindex="-1"><a class="header-anchor" href="#重要概念"><span>重要概念</span></a></h3><p><strong>控制机</strong></p><p>安装ansible 的机器，截止目前<code>2.9</code>，只支持Linux 和 Mac 作为控制机，不支持 Windows。配置文件默认路径<code>/etc/ansible/ansible.cfg</code>。</p><ul><li>官方文档：<a href="https://docs.ansible.com/ansible/latest/reference_appendices/config.html#ansible-configuration-settings-locations" target="_blank" rel="noopener noreferrer">配置文件字段详解</a></li></ul><p><strong>被控机</strong></p><p>在 ansible hosts 清单里的机器，控制机可ssh 登录。ssh 登录时，可使用用户名密码或私钥公钥登录。</p><p><strong>清单（Inventory）</strong></p><p>Ansible管理主机的清单，可ip、hostname，可分组控制。默认是 <code>/etc/ansible/hosts</code>文件，可使用 <code>-i &lt;path&gt;</code> 参数在命令行中指定。</p><ul><li>配置文件中，清单可以是文件或目录。当是目录的时候，ansible会合并目录中所有的静态清单和动态清单的数据。</li><li>官方文档：<a href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#intro-inventory" target="_blank" rel="noopener noreferrer">如何构建清单文件</a></li><li>清单理解：<a href="https://www.cnblogs.com/itwangqiang/p/13640601.html" target="_blank" rel="noopener noreferrer">Ansible_静态和动态清单文件管理</a></li></ul><p><strong>集合（Collections）</strong></p><p>一种ansible 的分发格式，包含剧本、角色、模块和插件。</p><p><strong>模块（Modules）</strong></p><p>Ansible执行命令的功能模块，执行代码的基本单元。Ansible2.3版本为止，共有1039个模块。还可以自定义模块。</p><ul><li>官方文档：<a href="https://docs.ansible.com/ansible/latest/collections/index.html#list-of-collections" target="_blank" rel="noopener noreferrer">可用模块列表</a></li></ul><p><strong>任务（Tasks）</strong></p><p>ansible 执行的任务单元。</p><p><strong>剧本（Playbooks）</strong></p><p>任务剧本（又称任务集），编排定义Ansible任务集的配置文件，由Ansible顺序依次执行，可重复执行，yaml格式。</p><ul><li>官方文档：<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html#playbooks-tips-and-tricks" target="_blank" rel="noopener noreferrer">编写playbook的技巧</a></li></ul><p><strong>ansible</strong></p><p>是<code>ansible</code>的命令工具，核心执行工具；一次性或临时执行的操作都是通过该命令执行。</p><p><strong>Plugins</strong></p><p>插件，模块功能的补充，常有连接类型插件，循环插件，变量插件，过滤插件，插件功能用的较少。</p><ul><li>官方文档：<a href="https://docs.ansible.com/ansible/latest/plugins/plugins.html" target="_blank" rel="noopener noreferrer">插件列表</a></li></ul><p><strong>API</strong></p><p>提供给第三方程序调用的应用程序编程接口。</p><ul><li><a href="https://ansible-runner.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">API 文档: ansible runner</a></li></ul><h3 id="变量" tabindex="-1"><a class="header-anchor" href="#变量"><span>变量</span></a></h3><p>清单文件中的变量：</p><div class="language-yml line-numbers-mode" data-highlighter="shiki" data-ext="yml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yml"><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">all:vars</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">foo1=bar</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">foo2=bar2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">group1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">host1</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">host2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">group1:vars</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">foo3=bar3</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PlayBook</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Playbook 中的变量：</p><div class="language-yml line-numbers-mode" data-highlighter="shiki" data-ext="yml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yml"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">---</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">-</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> hosts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> all</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  vars</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    http_port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  vars_prompt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service_name</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      prompt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Which service do you want to remove?</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      private</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> no</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  vars_files</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /vars/external_vars.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>角色专用变量，一般位于 <code>defaults/main.yml</code> 或者 <code>vars/ </code>目录下。官方文档，<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html" target="_blank" rel="noopener noreferrer">角色（Roles）</a></p><p>ansible 内部自定的变量，可以通过下面命令查看：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ansible</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> hostname</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -m</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> setup</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    &quot;ansible_all_ipv4_addresses&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        &quot;REDACTED IP ADDRESS&quot;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    ],</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    &quot;ansible_all_ipv6_addresses&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        &quot;REDACTED IPV6 ADDRESS&quot;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    ],</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    &quot;ansible_apparmor&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        &quot;status&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">disabled</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    &quot;ansible_architecture&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">x86_64</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    &quot;ansible_bios_date&quot;</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">11/28/2013</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        ......</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="变量作用域" tabindex="-1"><a class="header-anchor" href="#变量作用域"><span>变量作用域</span></a></h4><p>ansible 的变量作用域主要有 3 种：</p><ul><li>Global：ansible 配置文件，环境变量，命令行</li><li>Play：playbook vars, vars_prompt, vars_files; role defaults, vars</li><li>Host: Inventory 中定义的的 host vars; facts</li></ul><h4 id="变量使用" tabindex="-1"><a class="header-anchor" href="#变量使用"><span>变量使用</span></a></h4><p>ansible 允许你在各处通过 jinja2 的语法使用变量。jinja2 是一个用 Python 开发的模版引擎，本身并不复杂，核心东西就 3 个：变量的输出，控制流，过滤器。</p><p>需要注意的是，在 Ansible 中如果你要使用 jinja2 的语法去引用一个变量，必须用双引号内使用。</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">-</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> hosts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> all</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  vars</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    deploy_path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{{ home_dir }}/apps</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>比如我们想根据各种上下文生成 nginx 的配置文件，可以通过 template 命令来渲染。首先定一个模版文件 <code>nginx.conf.j2</code></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>server {</span></span>
<span class="line"><span>  server_name {{ server_name }};</span></span>
<span class="line"><span>  listen 80;</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>  location / {</span></span>
<span class="line"><span>    try_files $uri $uri/ /index.html;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们希望这个配置文件可以覆盖默认的 nginx 配置：</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">-</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> hosts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  vars</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    server_name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gio.com</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    nginx_user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    nginx_group</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{{ nginx_user }}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  tasks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> generate nginx config file</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      template</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        src</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx.conf.j2</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        dest</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/nginx/nginx.conf</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        owner</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{{ nginx_user }}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        group</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{{ nginx_group }}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      become</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> yes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ansible-应用" tabindex="-1"><a class="header-anchor" href="#ansible-应用"><span>Ansible 应用</span></a></h2><h3 id="命令行方式" tabindex="-1"><a class="header-anchor" href="#命令行方式"><span>命令行方式</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>ansible [pattern] -m [module] -a &quot;[module options]&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>pattern 匹配主机的模式</li><li><code>-m</code> 指定调用的模块</li><li><code>-a</code> 模块需要的参数</li></ul><p>更多参考<a href="https://docs.ansible.com/ansible/latest/cli/ansible.html#ansible" target="_blank" rel="noopener noreferrer">官方文档</a></p><h3 id="playbook-方式-yaml配置文件" tabindex="-1"><a class="header-anchor" href="#playbook-方式-yaml配置文件"><span>playbook 方式（yaml配置文件）</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>ansible-playbook &lt;playbook name&gt;.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>一个完整的playbook，一般包括三部分：基本信息和变量、task列表、handlers列表；</li><li>每个 task 的目标在于执行一个 moudle，通常是带有特定的参数来执行，在参数中可以使用变量；</li><li>每一个 task 必须有一个名称 name，这样在运行 playbook 时，从其输出的任务执行信息中可以很好的辨别出是属于哪一个 task 的。</li><li>module 格式为 <code>module: options</code>；</li></ul><p>更多参考<a href="https://docs.ansible.com/ansible/latest/cli/ansible-playbook.html#ansible-playbook" target="_blank" rel="noopener noreferrer">官方文档</a></p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">---</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">-</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> hosts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> webservers</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # 要执行的主机组，多个时逗号分隔，all 为全部</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  vars</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                 # 自定义变量</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    http_port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 80</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    max_clients</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 200</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  remote_user</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">     # 全局执行用户 </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  tasks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">                # 任务列表</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ensure apache is at the latest version</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    yum</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pkg=httpd state=latest</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> write the apache config file</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    template</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> src=/srv/httpd.j2 dest=/etc/httpd.conf</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    notify</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart apache</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ensure apache is running</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name=httpd state=started</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  handlers</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">             # 在发生改变时执行的操作  </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart apache</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name=httpd state=restarted</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行如下命令执行：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ansible-playbook</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> test.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="使用-role-角色" tabindex="-1"><a class="header-anchor" href="#使用-role-角色"><span>使用 Role(角色)</span></a></h3><p>统一管理playbook文件，可理解为一个标准的目录规范。可使用如下命令初始化一个角色目录：</p><p><code>ansible-galaxy init roles/role_nginx</code></p><p>整体目录结构如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">.</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">├──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx.yaml</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">              # 主调用play文件</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">└──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> roles</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    └──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> role_nginx</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ├──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> defaults</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # 默认变量存放的目录，文件中定义了此角色使用的默认变量；</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        │  </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> └──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> main.yml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ├──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> files</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">           # 存放有copy或script等模块调用的文件；</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ├──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> handlers</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        # 存放相关触发执行器的目录；</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        │  </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> └──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> main.yml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ├──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> meta</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            # 用于存放此角色元数据；</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        │  </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> └──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> main.yml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ├──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> README.md</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ├──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tasks</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">           # 任务存放的目录；</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        │  </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> └──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> main.yml</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ├──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> templates</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       # 存放template模块查找所需要的模板文件的目录；</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   └──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx.conf.j2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        ├──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tests</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        │  </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ├──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> inventory</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        │  </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> └──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> test.yml</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        └──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> vars</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">            # 变量存放的目录；</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            └──</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> main.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>roles 同目录，创建调用 play文件，即可应用整个角色。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>---</span></span>
<span class="line"><span>$ cat nginx.yaml </span></span>
<span class="line"><span>- hosts: webservers</span></span>
<span class="line"><span>  remote_user: root</span></span>
<span class="line"><span>  roles:</span></span>
<span class="line"><span>    - role: role_nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>角色文件的寻找目录：</p><ul><li>play 文件同级目录的role同名目录</li><li>play 文件统计目录的roles 目标下</li><li><code>~/.ansible/roles</code> 用户目录下</li><li>ansible.cfg 配置的角色目录下</li><li>/etc/ansible/roles 目录下</li><li>也可使用绝对路径配置角色</li></ul><p>运行如下命令执行：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ansible-playbook</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> nginx.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="更多文档" tabindex="-1"><a class="header-anchor" href="#更多文档"><span>更多文档</span></a></h2><ul><li><a href="http://www.zsythink.net/archives/category/%e8%bf%90%e7%bb%b4%e7%9b%b8%e5%85%b3/ansible/" target="_blank" rel="noopener noreferrer">朱双印ansible 系列文章</a></li><li><a href="https://ansible-tran.readthedocs.io/en/latest/docs/playbooks_best_practices.html" target="_blank" rel="noopener noreferrer">ansible 最佳实践</a></li></ul>`,79)])])}const k=i(l,[["render",t]]),r=JSON.parse('{"path":"/pages/f982be/","title":"Ansible 快速入门","lang":"zh-CN","frontmatter":{"title":"Ansible 快速入门","tags":["ansible"],"permalink":"/pages/f982be/","createTime":"2023/09/08 17:36:02","description":"Ansible 是自动化运维领域一款常用的服务器集群管理工具，他有丰富的文档和活跃的社区。 与同类型的竞品开源工具SaltStack/Puppet 相比，各有特色。可参考： https://www.edureka.co/blog/chef-vs-puppet-vs-ansible-vs-saltstack/ https://www.educba.com...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Ansible 快速入门\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-09-30T08:57:49.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://pylixm.top/pages/f982be/"}],["meta",{"property":"og:site_name","content":"底层逻辑"}],["meta",{"property":"og:title","content":"Ansible 快速入门"}],["meta",{"property":"og:description","content":"Ansible 是自动化运维领域一款常用的服务器集群管理工具，他有丰富的文档和活跃的社区。 与同类型的竞品开源工具SaltStack/Puppet 相比，各有特色。可参考： https://www.edureka.co/blog/chef-vs-puppet-vs-ansible-vs-saltstack/ https://www.educba.com..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-09-30T08:57:49.000Z"}],["meta",{"property":"article:tag","content":"ansible"}],["meta",{"property":"article:modified_time","content":"2025-09-30T08:57:49.000Z"}]]},"readingTime":{"minutes":5.71,"words":1714},"git":{"createdTime":1759222669000,"updatedTime":1759222669000,"contributors":[{"name":"pylixm","username":"pylixm","email":"pyli.xm@gmail.com","commits":1,"avatar":"https://avatars.githubusercontent.com/pylixm?v=4","url":"https://github.com/pylixm"}]},"autoDesc":true,"filePathRelative":"05.运维/20.ansible/20.Ansible-start.md","headers":[],"categoryList":[{"id":"8091bd","sort":5,"name":"运维"},{"id":"0ad47a","sort":20,"name":"ansible"}]}');export{k as comp,r as data};
