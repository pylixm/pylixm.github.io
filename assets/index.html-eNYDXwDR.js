import{_ as i,c as a,a as n,o as e}from"./app-DdES4ywf.js";const l="/imgs/traefik.png",p="/imgs/ingress-create.png",t="/imgs/ingress-tls.png",r="/imgs/show-svc.png",h="/imgs/show-svc2.png",d={};function k(c,s){return e(),a("div",null,[...s[0]||(s[0]=[n('<blockquote><p>本文主要记录了在 k3s 1.20 中安装 traefik v2 版本的主要步骤及问题，若你是升级 v1 到 v2，可直接参考官方文档<a href="https://doc.traefik.io/traefik/migration/v1-to-v2/" target="_blank" rel="noopener noreferrer">Migration Guide: From v1 to v2</a></p></blockquote><p>k3s 集群中默认使用 Traefik 作为 Ingress Controller，k3s 1.20 及更早版本默认安装 Traefik v1，而 k3s 1.21 及更高版本默认安装 Traefik v2，v2 版本在性能和功能性上都有比较大的提升。</p><p>我们集群为 k3s 1.20，默认安装的是 Traefik v1 版本，基于性能和功能丰富度的考虑，我们打算升级为 Traefik v2，因为我们集群为新集群，不涉及到已有 ingress 的兼容修改，我们采用卸载重新安装的方式。若为升级操作，可参考官方文档<a href="https://doc.traefik.io/traefik/migration/v1-to-v2/" target="_blank" rel="noopener noreferrer">Migration Guide: From v1 to v2</a>，逐一修改不兼容的地方。</p><p>下面是安装重点配置和问题记录。</p><h2 id="安装" tabindex="-1"><a class="header-anchor" href="#安装"><span>安装</span></a></h2><p>我们使用 helm 来进行安装，可以从 rancher 的应用商店中查看下支持的最新版本。</p><p><img src="'+l+`" alt="traefik"></p><p>若默认配置满足需求，完全可以通过上边的页面进行安装。若想自定义，可以通过页面右则下方的「Download」链接，下载 helm chart 来自定义配置安装。安装时和页面名称一致即可。</p><p>官方还有一种自定义修改默认安装组件的方法，使用 <a href="https://docs.rancher.cn/docs/k3s/helm/_index/#%E4%BD%BF%E7%94%A8-helmchartconfig-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%93%E5%8C%85%E7%9A%84%E7%BB%84%E4%BB%B6" target="_blank" rel="noopener noreferrer">helmchartconfig</a>，在配置清单目录中添加自定义配置，个人感觉不如直接自定义 helm chart 来的直接明了，大家可以尝试官方方案。</p><p>我们使用下载的 helm chart 进行自定义安装：</p><p><strong>1、编写自己的 values 来自定义部分配置。</strong></p><p>下面是我安装时自定义的values文件 <code>k3s-values.yaml</code> ，可参考：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span># 默认的 ingressRouter 是开启的，使用内部 CRD service，自定义dashboard ingressroute时，可设置为 false，自己创建。</span></span>
<span class="line"><span># ingressRoute:</span></span>
<span class="line"><span>#   dashboard:</span></span>
<span class="line"><span>#     enabled: false</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>deployment:</span></span>
<span class="line"><span>  enabled: true</span></span>
<span class="line"><span>  # Can be either Deployment or DaemonSet</span></span>
<span class="line"><span>  kind: Deployment</span></span>
<span class="line"><span>  # Number of pods of the deployment (only applies when kind == Deployment)</span></span>
<span class="line"><span>  replicas: 2</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ports:</span></span>
<span class="line"><span>  traefik:</span></span>
<span class="line"><span>    port: 9000</span></span>
<span class="line"><span>    # You SHOULD NOT expose the traefik port on production deployments.</span></span>
<span class="line"><span>    # If you want to access it from outside of your cluster,</span></span>
<span class="line"><span>    # use \`kubectl port-forward\` or create a secure ingress</span></span>
<span class="line"><span>    # kubectl port-forward $(kubectl get pods --selector &quot;app.kubernetes.io/name=traefik&quot; --output=name -n cattle-system) 9000:9000 -n cattle-system</span></span>
<span class="line"><span>    expose: false</span></span>
<span class="line"><span>    exposedPort: 9000</span></span>
<span class="line"><span>  web:</span></span>
<span class="line"><span>    port: 8000</span></span>
<span class="line"><span>    expose: true</span></span>
<span class="line"><span>    exposedPort: 80</span></span>
<span class="line"><span>  websecure:</span></span>
<span class="line"><span>    port: 8443</span></span>
<span class="line"><span>    expose: true</span></span>
<span class="line"><span>    exposedPort: 443</span></span>
<span class="line"><span>    tls:</span></span>
<span class="line"><span>      enabled: true  # 需要开启，否则配置的ingress不支持配置tls证书</span></span>
<span class="line"><span>  metrics:</span></span>
<span class="line"><span>    port: 9100</span></span>
<span class="line"><span>    expose: true</span></span>
<span class="line"><span>    exposedPort: 9100</span></span>
<span class="line"><span></span></span>
<span class="line"><span>affinity: </span></span>
<span class="line"><span>  podAntiAffinity:</span></span>
<span class="line"><span>    requiredDuringSchedulingIgnoredDuringExecution:</span></span>
<span class="line"><span>      - labelSelector:</span></span>
<span class="line"><span>          matchExpressions:</span></span>
<span class="line"><span>            - key: app.kubernetes.io/name</span></span>
<span class="line"><span>              operator: In</span></span>
<span class="line"><span>              values:</span></span>
<span class="line"><span>                - traefik</span></span>
<span class="line"><span>        topologyKey: kubernetes.io/hostname</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2、使用helm 安装</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span># 安装</span></span>
<span class="line"><span>helm install traefik ./ -n cattle-system -f k3s-values.yaml</span></span>
<span class="line"><span># 更新自定义配置时使用</span></span>
<span class="line"><span>helm upgrade --install traefik ./ -n cattle-system -f k3s-values.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样便按照好了，不过在给出上边配置，之前我遇到了好几个问题，可参考，避免采坑。</p><h2 id="问题记录" tabindex="-1"><a class="header-anchor" href="#问题记录"><span>问题记录</span></a></h2><p><strong>1、dashboard 如何配置？</strong></p><p>官方提供了两种方式，第一种为<code>port-forward</code> 直接端口映射到本地访问，步骤如下：</p><ul><li>1、通过<code>ingressRoute</code>创建路由，<code>helm chart</code>中默认是创建的，如想自定义可设置为 false, 自己创建<code>ingress</code>或<code>ingressRoute</code>。</li><li>2、通过 <code>port-forward</code> 绑定端口</li></ul><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> port-forward</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> $(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">kubectl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> pods</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --selector</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">app.kubernetes.io/name=traefik</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --output=name</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cattle-system</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 9000:9000</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cattle-system</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>访问本地的 <code>localhost:9000/dashboard/</code> 即可，dashboard 后边的 <code>/</code>一定要有，否则会报 404。</p><p>第二种为直接暴露端口，步骤如下：</p><p>1、修改 values 配置如下：</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">ports</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  traefik</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 9000</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    expose</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> ## &lt;&lt;&lt; 改为 true，默认为 false</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    exposedPort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 9000</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2、执行更新配置命令：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">helm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> upgrade</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> traefik</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cattle-system</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> k3s-values.yaml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>3、此时会看到 traefik 这个service 暴露了 9000 端口，我们可以通过 rancher 创建一个普通的ingress。</p><p><img src="`+p+`" alt="image"></p><p>主机域名绑定集群节点ip，即可通过<code>http://traefik-prod.example.com/dashboard/#/</code> 访问。</p><p>基于安全方面的考虑，官方更推荐第一种方案。</p><p><strong>2、tls 如何支持？</strong></p><p>该 charts 中有个比较坑的地方，如下：</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  websecure</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8443</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    expose</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    exposedPort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 443</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    tls</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      enabled</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  #&lt;&lt; 默认关闭，需要开启，否则配置的ingress不支持配置tls证书</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ports.websecure.tls.enabled</code> 默认是 false，这就导致在 ingress 中配置自定义证书不生效。当需要 https 的<code>ingress</code>时，该参数一定要打开。</p><p><img src="`+t+'" alt="image"></p><p><strong>3、k3s 中 traefik 部署方式问题？</strong></p><p>在 k8s 中，ingress 有3种部署方式：</p><ul><li>1、IngressController作为DaemonSet部署，暴露hostPort；</li><li>2、作为 Deployment 部署，给IngressController开一个NodePort服务；</li><li>3、作为 Deployment 部署，给IngressController暴露一个LoadBalancer服务(需要借助云厂商提供的cloud provider能力分配ip)；</li></ul><p>在 k3s 中，使用了一个叫<a href="https://docs.rancher.cn/docs/k3s/networking/_index/#service-load-balancer" target="_blank" rel="noopener noreferrer">Klipper Load Balancer</a>负载均衡器，它会以daemonset 的方式默认在所有节点上跑一个pod（当节点配置污点时，会启动报错，这里需要自己配置），作为代理服务。所以在 k3s 中，traefik 以 Deployment 和 DaemonSet 方式部署效果是一样的。</p><p>对比k8s第二种方式部署的 traefik 情况如下：</p><p><img src="'+r+'" alt="k3s"></p><p><img src="'+h+`" alt="k8s"></p><p><strong>4、traefik 部署副本问题？</strong></p><p>在k8s中 traefik 部署在那个node 节点，那个就可以接流量。但是在k3s中由于使用了 <code>Klipper Load Balancer</code>，默认所有节点都可以接流量，但是<code>svclb</code>这个 daemonset 是依赖 <code>traefik</code>这个服务的，当 <code>traefik</code> 服务重启时，<code>svclb</code> 不可用。建议最少配置 2 个traefik pod，且开启非亲和性，让pod不要部署在一个node节点，提高可用性。</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">deployment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  enabled</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # Can be either Deployment or DaemonSet</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  kind</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Deployment</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # Number of pods of the deployment (only applies when kind == Deployment)</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  replicas</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  ## &lt;&lt;&lt;&lt; 至少两个副本，且开启pod 非亲和性。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">affinity</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  podAntiAffinity</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    requiredDuringSchedulingIgnoredDuringExecution</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> labelSelector</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">          matchExpressions</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">            -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> key</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> app.kubernetes.io/name</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">              operator</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> In</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">              values</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> traefik</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        topologyKey</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> kubernetes.io/hostname</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>5、traefik 监控配置？</strong></p><p>在 charts 中metrics的监控接口并没有启动，我们可以修改<code>ports.metrics.expose</code>参数启动，如下：</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  metrics</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 9100</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    expose</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # &lt;&lt;&lt; 改为true，默认为false</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    exposedPort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 9100</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之后增加一个 <code>serviceMonitor</code>，就能在 Prometheus 中看到该 target 了。</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">apiVersion</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> monitoring.coreos.com/v1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">kind</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ServiceMonitor</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">metadata</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> traefik</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  namespace</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cattle-monitoring-system</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  labels</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    app.kubernetes.io/name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> traefik</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">spec</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  jobLabel</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> app.kubernetes.io/name</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  selector</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    matchLabels</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      app.kubernetes.io/name</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> traefik</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # 服务发现label</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  namespaceSelector</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    matchNames</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cattle-system</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # traefik安装的命名空间</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  endpoints</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">  -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> metrics</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    interval</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 30s</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /metrics</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>Rancher 中大部分组件都可以通过自定 <code>helm chart</code> 来安装，只要保持资源名字一致即可。可以先用 Rancher 的应用商店中的 chart 包安装一遍，创建些应用需要的CRD，再使用 <code>helm chart</code>安装。</p>`,53)])])}const g=i(d,[["render",k]]),m=JSON.parse('{"path":"/pages/2f8a83/","title":"k3s 中 helm 自定义安装 traefik v2","lang":"zh-CN","frontmatter":{"title":"k3s 中 helm 自定义安装 traefik v2","description":"k3s 下traefik v2 的安装步骤和问题解决。","toc":true,"tags":["Kubernetes","k3s"],"draft":false,"permalink":"/pages/2f8a83/","createTime":"2023/09/08 17:36:02","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"k3s 中 helm 自定义安装 traefik v2\\",\\"image\\":[\\"https://pylixm.top/imgs/traefik.png\\",\\"https://pylixm.top/imgs/ingress-create.png\\",\\"https://pylixm.top/imgs/ingress-tls.png\\",\\"https://pylixm.top/imgs/show-svc.png\\",\\"https://pylixm.top/imgs/show-svc2.png\\"],\\"dateModified\\":\\"2025-09-30T08:57:49.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://pylixm.top/pages/2f8a83/"}],["meta",{"property":"og:site_name","content":"底层逻辑"}],["meta",{"property":"og:title","content":"k3s 中 helm 自定义安装 traefik v2"}],["meta",{"property":"og:description","content":"k3s 下traefik v2 的安装步骤和问题解决。"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://pylixm.top/imgs/traefik.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-09-30T08:57:49.000Z"}],["meta",{"property":"article:tag","content":"k3s"}],["meta",{"property":"article:tag","content":"Kubernetes"}],["meta",{"property":"article:modified_time","content":"2025-09-30T08:57:49.000Z"}]]},"readingTime":{"minutes":5.49,"words":1646},"git":{"createdTime":1759222669000,"updatedTime":1759222669000,"contributors":[{"name":"pylixm","username":"pylixm","email":"pyli.xm@gmail.com","commits":1,"avatar":"https://avatars.githubusercontent.com/pylixm?v=4","url":"https://github.com/pylixm"}]},"filePathRelative":"04.云原生/02.k3s/04.k3s-traefik.md","headers":[],"categoryList":[{"id":"e467f5","sort":4,"name":"云原生"},{"id":"e868ae","sort":2,"name":"k3s"}]}');export{g as comp,m as data};
