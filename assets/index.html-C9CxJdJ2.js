import{_ as s,c as i,a,o as n}from"./app-Cpl7-wzY.js";const t={};function l(r,e){return n(),i("div",null,[...e[0]||(e[0]=[a(`<h2 id="问题描述" tabindex="-1"><a class="header-anchor" href="#问题描述"><span>问题描述</span></a></h2><p>在部署 statefulset 类型的工作负载时，动态创建 PV/PVC 是一种比较常用的配置方式，动态创建 PV/PVC 的方法基本如下：</p><ul><li>1、创建自己的 StorageClass 备用。</li><li>2、创建 statefulset ，在 yaml 文件的 <code>volumeClaimTemplates</code> 块，添加 StorageClass 的名字。</li></ul><p>说回今天遇到的问题，在部署 VictoriaMetric 时，想使用阿里云的 nfs 做为外部存储，以进一步提高可用性。先使用 mysql 的 demo 案例（yaml 示例见<a href="https://github.com/pylixm/k8s-yaml-hub" title="这里 k8s-yaml-hub" target="_blank" rel="noopener noreferrer">这里 k8s-yaml-hub</a>），来测试下 statefulset 的在使用 nfs 时的分部情况。</p><p>一直启动不动来，查看 pvc 和 pods 信息如下：</p><ul><li>1、PVC 一直处于 pending 状态；</li><li>2、mysql pods 显示：<code>0/3 nodes are available: 3 pod has unbound immediate PersistentVolumeClaims.</code><img src="https://gitee.com/pylixm/picture/raw/master/2022-2-15/1644888438770-QQ20220215-092444@2x.png" alt="QQ20220215-092444@2x"></li></ul><h2 id="原因分析" tabindex="-1"><a class="header-anchor" href="#原因分析"><span>原因分析</span></a></h2><p>从上边的现象来看，是 PVC 没有创建成功，动态 PVC 中，是 provisioner 中来负责创建，查看其日志，看到如下错误信息：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>I0214 10:22:35.436913 1 controller.go:1068] scheduleOperation[provision-mysql-sts/mysql-pvc-mysql-0[ac333031-e705-48d9-8180-4d2d583bb559]]</span></span>
<span class="line"><span>E0214 10:22:35.444757 1 controller.go:766] Unexpected error getting claim reference to claim &quot;mysql-sts/mysql-pvc-mysql-0&quot;: selfLink was empty, can&#39;t make reference</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Google 之后，很多人遇到了同样的问题，主要原因是，官方在 k8s 1.20 中基于对性能和统一<code>apiserver</code>调用方式的初衷，移除了对 SelfLink 的支持，而 nfs-provisioner 需要 SelfLink 该项功能。具体计划和原因可查看这个<a href="https://github.com/kubernetes/kubernetes/pull/94397" title="issue" target="_blank" rel="noopener noreferrer">issue</a> 和 <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-api-machinery/1164-remove-selflink" title="KEP" target="_blank" rel="noopener noreferrer">KEP</a>。</p><p>K3S 为兼容 K8S 应该也继承了该项修改，按 K8S 的方式修改测试了下，完美解决。</p><h2 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案"><span>解决方案</span></a></h2><p>解决问题主要有下边两种方式：</p><p>1、修改 apiserver 的配置文件，重新启用 SelfLink 功能。针对 K8S，可添加如下配置：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span># /etc/kubernetes/manifests/kube-apiserver.yaml</span></span>
<span class="line"><span></span></span>
<span class="line"><span>spec:</span></span>
<span class="line"><span>  containers:</span></span>
<span class="line"><span>  - command:</span></span>
<span class="line"><span>    - kube-apiserver</span></span>
<span class="line"><span>    ...</span></span>
<span class="line"><span>    - --feature-gates=RemoveSelfLink=false # 增加</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>K3S 中没有 apiserver 的配置文件，可通过 systemd 的启动文件添加该参数，如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span># /etc/systemd/system/k3s.service</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ExecStart=/usr/local/bin/k3s \\</span></span>
<span class="line"><span>    server \\</span></span>
<span class="line"><span>        ...</span></span>
<span class="line"><span>        &#39;--kube-apiserver-arg&#39; \\   # 新增</span></span>
<span class="line"><span>        &#39;feature-gates=RemoveSelfLink=false&#39; \\  # 新增</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>若为新安装，可如下启用：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ curl -sfL https://get.k3s.io | sh -s - --kube-apiserver-arg &quot;feature-gates=RemoveSelfLink=false&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2、使用新的不基于 SelfLink 功能的 provisioner 镜像，重新创建 provisioner 容器。</p><p>若你能科学上网，可使用这个镜像：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>gcr.io/k8s-staging-sig-storage/nfs-subdir-external-provisioner:v4.0.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>国内可使用这个镜像：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>registry.cn-beijing.aliyuncs.com/pylixm/nfs-subdir-external-provisioner:v4.0.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>记录备查，希望对你有帮助。</p>`,25)])])}const d=s(t,[["render",l]]),c=JSON.parse('{"path":"/pages/650257/","title":"k3s 中 selflink 问题排查解决","lang":"zh-CN","frontmatter":{"title":"k3s 中 selflink 问题排查解决","description":"k8s、k3s 中动态创建pv、pvc时，Provisioner出现 selflink 错误解决方案。","toc":true,"tags":["Kubernetes","k3s"],"draft":false,"permalink":"/pages/650257/","createTime":"2023/09/08 17:36:02","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"k3s 中 selflink 问题排查解决\\",\\"image\\":[\\"https://gitee.com/pylixm/picture/raw/master/2022-2-15/1644888438770-QQ20220215-092444@2x.png\\"],\\"dateModified\\":\\"2025-09-30T08:57:49.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://pylixm.top/pages/650257/"}],["meta",{"property":"og:site_name","content":"底层逻辑"}],["meta",{"property":"og:title","content":"k3s 中 selflink 问题排查解决"}],["meta",{"property":"og:description","content":"k8s、k3s 中动态创建pv、pvc时，Provisioner出现 selflink 错误解决方案。"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://gitee.com/pylixm/picture/raw/master/2022-2-15/1644888438770-QQ20220215-092444@2x.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-09-30T08:57:49.000Z"}],["meta",{"property":"article:tag","content":"k3s"}],["meta",{"property":"article:tag","content":"Kubernetes"}],["meta",{"property":"article:modified_time","content":"2025-09-30T08:57:49.000Z"}]]},"readingTime":{"minutes":2.13,"words":639},"git":{"createdTime":1759222669000,"updatedTime":1759222669000,"contributors":[{"name":"pylixm","username":"pylixm","email":"pyli.xm@gmail.com","commits":1,"avatar":"https://avatars.githubusercontent.com/pylixm?v=4","url":"https://github.com/pylixm"}]},"filePathRelative":"04.云原生/02.k3s/05.k3s-selflink.md","headers":[],"categoryList":[{"id":"e467f5","sort":4,"name":"云原生"},{"id":"e868ae","sort":2,"name":"k3s"}]}');export{d as comp,c as data};
