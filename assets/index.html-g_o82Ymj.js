import{_ as i,c as n,a,o as e}from"./app-Cpl7-wzY.js";const l="/imgs/DNS.png",p={};function d(t,s){return e(),n("div",null,[...s[0]||(s[0]=[a('<p>最近在处理问题时，看到 <code>dnsmasq</code> 这个工具，经查阅资料知道它是一款轻量级的网络相关的软件，可以配置作为DNS缓存服务器和DHCP服务器使用。</p><p>结合之前了解的DNS知识，总结下。</p><h2 id="前提知识点" tabindex="-1"><a class="header-anchor" href="#前提知识点"><span>前提知识点</span></a></h2><p><strong>DNS</strong></p><p>DNS是 Domain Name System 的缩写，中文意思为域名解析系统，用来做域名和IP的翻译解析，即可以根据有意义的域名找到无意义的IP，从而去请求该IP对应的服务。</p><p>DNS 根据域名的分级会有不同类型的DNS服务器来解析不同的域名。主要可参考下图：</p><p><img src="'+l+`" alt=""></p><p>DNS 服务器分为：</p><ul><li><p>根域名服务器：最高层次的域名服务器，所有的根域名服务器都知道所有的顶级域名服务器的域名和IP地址。本地域名服务器解析域名，首先求助根域名服务器。在很多情况下，根域名服务器并不直接把待查询的域名直接解析出IP地址，而是告诉本地域名服务器下一步应当找哪一个顶级域名服务器进行查询。所有根服务器均由美国政府授权的互联网域名与号码分配机构ICANN统一管理，负责全球互联网域名根服务器、域名体系和IP地址等的管理。更多详情，可参阅<a href="https://lcx.cc/post/2343/" target="_blank" rel="noopener noreferrer">DNS根服务器、根服务器、全球13台根域名服务器、详细介绍</a></p></li><li><p>顶级域名服务器：负责管理在该顶级域名服务器注册的二级域名，如.com .cn 等。</p></li><li><p>权限域名服务器：负责一个“区”的域名服务器。</p></li><li><p>本地域名服务器：本地域名服务器，一般为本地网络的域名服务器。若我们直接连接的是运营商的网络，那么本地域名服务器便是运营商的域名服务器。</p></li></ul><blockquote><p>以下内容转自：https://www.hi-linux.com/posts/30947.html</p></blockquote><h2 id="dnsmasq" tabindex="-1"><a class="header-anchor" href="#dnsmasq"><span>DNSmasq</span></a></h2><h3 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍"><span>介绍</span></a></h3><p>DNSmasq提供DNS服务、DHCP服务和路由通告（Router Advertisement）等服务。作为域名解析服务器(DNS)，Dnsmasq可以通过缓存DNS请求来提高对访问过的网址的连接速度。作为DHCP服务器，Dnsmasq可以为局域网电脑提供内网ip地址和路由。DNS和DHCP两个功能可以同时或分别单独实现。Dnsmasq轻量且易配置，适用于个人用户或少于50台主机的网络。此外它还自带了一个PXE服务器。它还被广泛用于智能手机和便携式热点的网络共享，并支持虚拟化框架中的虚拟网络。 支持的平台包括Linux（带glibc和uclibc），Android，* BSD和Mac OS X.Dnsmasq包含在大多数Linux发行版和FreeBSD，OpenBSD和NetBSD的ports系统中。 Dnsmasq提供完整的IPv6支持。</p><h3 id="工作原理" tabindex="-1"><a class="header-anchor" href="#工作原理"><span>工作原理</span></a></h3><p>当接受到一个DNS请求时，Dnsmasq首先会查找/etc/hosts这个文件，然后查找/etc/resolv.conf中定义的外部DNS。所以说Dnsmasq是一个很不错的外部DNS中继。</p><p>配置Dnsmasq为DNS缓存服务器，同时在/etc/hosts文件中加入本地内网解析，这样一来每当内网机器查询时就会优先查询hosts文件，这就等于将/etc/hosts共享给全内网机器使用，从而解决内网机器互相识别的问题。相比逐台机器编辑hosts文件或者添加Bind DNS记录，仅编辑一个hosts文件，这就容易多了。</p><h3 id="使用" tabindex="-1"><a class="header-anchor" href="#使用"><span>使用</span></a></h3><h4 id="安装" tabindex="-1"><a class="header-anchor" href="#安装"><span>安装</span></a></h4><p><strong>Ubuntu/Debian</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> apt-get</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dnsmasq</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Centos/RHEL</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ yum install dnsmasq</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="配置dnsmasq" tabindex="-1"><a class="header-anchor" href="#配置dnsmasq"><span>配置Dnsmasq</span></a></h4><p>Dnsmasq处理DNS设置与BIND等其他DNS服务有所不同。所有的配置都在一个文件中完成/etc/dnsmasq.conf。默认情况下dnsmasq.conf中只开启了最后include项，可以在/etc/dnsmasq.d中自己写任意名字的配置文件。</p><p>配置文件说明</p><p>Dnsmasq配置文件是/etc/dnsmasq.conf，下面对Dnsmasq中和DNS相关的配置项进行说明。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">用指定的端口代替默认的DNS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 53端口，如果设置为0，则完全禁止DNS功能，只使用dhcp服务</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">5353</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">以下两个参数告诉Dnsmasq过滤一些查询：1.哪些公共DNS没有回答</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 2.哪些root根域不可达。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">从不转发格式错误的域名</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#domain-needed</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">从不转发不在路由地址中的域名</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#bogus-priv</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">resolv-file配置Dnsmasq额外的向流的DNS服务器，如果不开启就使用linux主机默认的/etc/resolv.conf里的nameserver，通过下面的选项指定其他文件。</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">resolv-file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/dnsmasq.d/upstream_dns.conf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">默认情况下Dnsmasq会发送查询到它的任何上游DNS服务器上，如果取消注释，则Dnsmasq则会严格按照/etc/resolv.conf中的DNS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Server顺序进行查询。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#strict-order</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">以下两个参数控制是否通过/etc/resolv.conf确定上游服务器，是否检测/etc/resolv.conf的变化，则取消注释。</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">如果你不想Dnsmasq读取/etc/resolv.conf文件或者其他文件，获得它的servers</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># If you don&#39;t want dnsmasq to read /etc/resolv.conf or any other</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># file, getting its servers from this file instead (see below), then</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># uncomment this.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#no-resolv</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">如果你不允许Dnsmasq通过轮询/etc/resolv.conf或者其他文件来获取配置的改变，则取消注释。</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#no-poll</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">增加一个name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server，一般用于内网域名</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#server=/localnet/192.168.0.1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">设置一个反向解析，所有192.168.3.0/24的地址都到10.1.2.3去解析</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#server=/3.168.192.in-addr.arpa/10.1.2.3</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">增加一个本地域名，会在/etc/hosts中进行查询</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#local=/localnet/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">增加一个域名，强制解析到你指定的地址上</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#address=/double-click.net/127.0.0.1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">同上，还支持ipv6</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#address=/www.thekelleys.org.uk/fe80::20d:60ff:fe36:f83</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">增加查询yahoo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> google和它们的子域名到vpn、search查找</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Add the IPs of all queries to yahoo.com, google.com, and their</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># subdomains to the vpn and search ipsets:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#ipset=/yahoo.com/google.com/vpn,search</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">你还可以控制Dnsmasq和Server之间的查询从哪个网卡出去</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># server=10.1.2.3@eth1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">指定源地址携带10.1.2.3地址和192.168.1.1的55端口进行通讯</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># and this sets the source (ie local) address used to talk to</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 10.1.2.3 to 192.168.1.1 port 55 (there must be a interface with that</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># IP on the machine, obviously).</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># server=10.1.2.3@192.168.1.1#55</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">改变Dnsmasq默认的uid和gid</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#user=</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#group=</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">如果你想Dnsmasq监听某个端口为dhcp、dns提供服务</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#interface=</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">你还可以指定哪个端口你不想监听</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#except-interface=</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">设置想监听的地址，如果你本机要使用写上127.0.0.1。</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#listen-address=</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">如果你想在某个端口只提供dns服务，则可以进行配置禁止dhcp服务</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#no-dhcp-interface=</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># On systems which support it, dnsmasq binds the wildcard address,</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># even when it is listening on only some interfaces. It then discards</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># requests that it shouldn&#39;t reply to. This has the advantage of</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># working even when interfaces come and go and change address. If you</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># want dnsmasq to really bind only the interfaces it is listening on,</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># uncomment this option. About the only time you may need this is when</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># running another nameserver on the same machine.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#bind-interfaces</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">如果你不想使用/etc/hosts，则取消下面的注释</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#no-hosts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">如果你项读取其他类似/etc/hosts文件，则进行配置</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">addn-hosts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/banner_add_hosts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">自动的给hosts中的name增加一个域名</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#expand-hosts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">给dhcp服务赋予一个域名</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#domain=thekelleys.org.uk</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">给dhcp的一个子域赋予一个不同的域名</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#domain=wireless.thekelleys.org.uk,192.168.2.0/24</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">同上，不过子域是一个范围</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#domain=reserved.thekelleys.org.uk,192.68.3.100,192.168.3.200</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">dhcp分发ip的范围，以及每个ip的租约时间</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#dhcp-range=192.168.0.50,192.168.0.150,12h</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">同上，不过给出了掩码</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#dhcp-range=192.168.0.50,192.168.0.150,255.255.255.0,12h</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">自动加载conf-dir目录下的配置文件</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">conf-dir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/dnsmasq.d</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">设置dns缓存大小,默认为150条</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">cache-size</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">150</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="配置实例" tabindex="-1"><a class="header-anchor" href="#配置实例"><span>配置实例</span></a></h4><p><strong>配置上游服务器地址</strong></p><p>resolv-file配置Dnsmasq额外的上游的DNS服务器，如果不开启就使用Linux主机默认的/etc/resolv.conf里的nameserver。</p><p>通过下面的选项指定其他文件来管理上游的DNS服务器</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ vi /etc/dnsmasq.conf</span></span>
<span class="line"><span></span></span>
<span class="line"><span>resolv-file=/etc/resolv.dnsmasq.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在指定文件中增加转发DNS的地址</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ vi /etc/resolv.dnsmasq.conf</span></span>
<span class="line"><span></span></span>
<span class="line"><span>nameserver 8.8.8.8</span></span>
<span class="line"><span>nameserver 8.8.4.4</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>本地启用Dnsmasq解析</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ vi /etc/resolv.conf</span></span>
<span class="line"><span></span></span>
<span class="line"><span>nameserver 127.0.0.1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加解析记录 使用系统默认hosts 编辑hosts文件,简单列举一下格式</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ vi /etc/hosts</span></span>
<span class="line"><span></span></span>
<span class="line"><span>127.0.0.1  localhost </span></span>
<span class="line"><span>192.168.101.107   web01.mike.com web01</span></span>
<span class="line"><span>192.168.101.107   web02.mike.com web02</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>hosts文件的强大之处还在于能够劫持解析，譬如mirror.centos.org是CentOS仓库所在，几乎是机器正常必访问一个域名，我将它解析成一个内网地址，搭建一个内网镜像站，不仅内网机器也可以及时得到安全更新，每月还可以节省很多流量。</p><p>使用自定义hosts文件 修改配置，增加自定义hosts文件位置。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ vi /etc/dnsmasq.conf</span></span>
<span class="line"><span></span></span>
<span class="line"><span>addn-hosts=/etc/dnsmasq.hosts</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在/etc/dnsmasq.hosts文件中添加DNS记录</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ vi /etc/dnsmasq.hosts</span></span>
<span class="line"><span></span></span>
<span class="line"><span>192.168.101.107   web01.mike.com    web01 </span></span>
<span class="line"><span>192.168.101.107   web02.mike.com    web02</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用自定义conf</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ vi /etc/dnsmasq.d/address.conf</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 指定dnsmasq默认查询的上游服务器，此处以Google Public DNS为例。</span></span>
<span class="line"><span>server=8.8.8.8</span></span>
<span class="line"><span>server=8.8.4.4</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 把所有.cn的域名全部通过114.114.114.114这台国内DNS服务器来解析</span></span>
<span class="line"><span>server=/cn/114.114.114.114</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 给*.apple.com和taobao.com使用专用的DNS</span></span>
<span class="line"><span>server=/taobao.com/223.5.5.5</span></span>
<span class="line"><span>server=/.apple.com/223.5.5.5</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 把www.hi-linux.com解析到特定的IP</span></span>
<span class="line"><span>address=/www.hi-linux.com/192.168.101.107</span></span>
<span class="line"><span></span></span>
<span class="line"><span>在这里hi-linux.com相当于*.mike.com泛解析</span></span>
<span class="line"><span>address=/hi-linux.com/192.168.101.107</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注：也可以直接添加到/etc/dnsmasq.conf中,不过/etc/dnsmasq.d/*.conf的优先级大于/etc/dnsmasq.conf。</p><h4 id="修改iptables配置" tabindex="-1"><a class="header-anchor" href="#修改iptables配置"><span>修改iptables配置</span></a></h4><p>允许本机的53端口可对外访问</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ iptables -A INPUT -p udp -m udp --dport 53 -j ACCEPT</span></span>
<span class="line"><span>$ iptables -A INPUT -p tcp -m tcp --dport 53 -j ACCEPT</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>转发DNS请求</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span># 开启流量转发功能</span></span>
<span class="line"><span>$ echo &#39;1&#39; &gt; /proc/sys/net/ipv4/ip_forward</span></span>
<span class="line"><span>$ echo &#39;1&#39; &gt; /proc/sys/net/ipv6/ip_forward   # IPv6 用户选用</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 添加流量转发规则，将外部到53的端口的请求映射到Dnsmasq服务器的53端口</span></span>
<span class="line"><span>$ iptables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-ports 53</span></span>
<span class="line"><span>$ iptables -t nat -A PREROUTING -p tcp --dport 53 -j REDIRECT --to-ports 53</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 如果要限制只允许内网的请求，方法如下</span></span>
<span class="line"><span>$ iptables -t nat -A PREROUTING -i eth1 -p upd --dport 53 -j REDIRECT --to-port 53</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>保存规则并重启</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ service iptables save</span></span>
<span class="line"><span>$ service iptables restart</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="测试dnsmasq" tabindex="-1"><a class="header-anchor" href="#测试dnsmasq"><span>测试Dnsmasq</span></a></h4><p>启动Dnsmasq</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ service dnsmasq start</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>测试Dnsmasq 将其他机器的DNS换成dnsmasq所在的IP即可，就这么容易。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>$ dig @192.168.101.104 www.hi-linux.com</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>其他可参阅官网：http://www.thekelleys.org.uk/dnsmasq/</p><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考"><span>参考</span></a></h2><ul><li><a href="https://lcx.cc/post/2343/" target="_blank" rel="noopener noreferrer">https://lcx.cc/post/2343/</a></li><li><a href="https://blog.csdn.net/yipiankongbai/article/details/25031461" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/yipiankongbai/article/details/25031461</a></li><li><a href="https://www.hi-linux.com/posts/30947.html" target="_blank" rel="noopener noreferrer">https://www.hi-linux.com/posts/30947.html</a></li></ul>`,61)])])}const h=i(p,[["render",d]]),c=JSON.parse('{"path":"/pages/24c5bb/","title":"DNS 相关知识记录","lang":"zh-CN","frontmatter":{"title":"DNS 相关知识记录","tags":["运维知识库","DNS"],"permalink":"/pages/24c5bb/","createTime":"2023/09/08 17:36:02","description":"最近在处理问题时，看到 dnsmasq 这个工具，经查阅资料知道它是一款轻量级的网络相关的软件，可以配置作为DNS缓存服务器和DHCP服务器使用。 结合之前了解的DNS知识，总结下。 前提知识点 DNS DNS是 Domain Name System 的缩写，中文意思为域名解析系统，用来做域名和IP的翻译解析，即可以根据有意义的域名找到无意义的IP，从...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"DNS 相关知识记录\\",\\"image\\":[\\"https://pylixm.top/imgs/DNS.png\\"],\\"dateModified\\":\\"2025-09-30T08:57:49.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://pylixm.top/pages/24c5bb/"}],["meta",{"property":"og:site_name","content":"底层逻辑"}],["meta",{"property":"og:title","content":"DNS 相关知识记录"}],["meta",{"property":"og:description","content":"最近在处理问题时，看到 dnsmasq 这个工具，经查阅资料知道它是一款轻量级的网络相关的软件，可以配置作为DNS缓存服务器和DHCP服务器使用。 结合之前了解的DNS知识，总结下。 前提知识点 DNS DNS是 Domain Name System 的缩写，中文意思为域名解析系统，用来做域名和IP的翻译解析，即可以根据有意义的域名找到无意义的IP，从..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://pylixm.top/imgs/DNS.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-09-30T08:57:49.000Z"}],["meta",{"property":"article:tag","content":"DNS"}],["meta",{"property":"article:tag","content":"运维知识库"}],["meta",{"property":"article:modified_time","content":"2025-09-30T08:57:49.000Z"}]]},"readingTime":{"minutes":8.42,"words":2527},"git":{"createdTime":1759222669000,"updatedTime":1759222669000,"contributors":[{"name":"pylixm","username":"pylixm","email":"pyli.xm@gmail.com","commits":1,"avatar":"https://avatars.githubusercontent.com/pylixm?v=4","url":"https://github.com/pylixm"}]},"autoDesc":true,"filePathRelative":"05.运维/03.其他/10.DNSmasq-start.md","headers":[],"categoryList":[{"id":"8091bd","sort":5,"name":"运维"},{"id":"b3e39d","sort":3,"name":"其他"}]}');export{h as comp,c as data};
