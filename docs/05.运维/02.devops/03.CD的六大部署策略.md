---
title: CD的六大部署策略
permalink: /pages/0d9aec/
  - devops
tags:
  - null
createTime: 2023/09/08 17:36:02
---

> 原文： https://thenewstack.io/deployment-strategies/

有多种技术可以将新应用程序部署到生产中，因此选择正确的策略是一个重要的决定，根据变更对系统和最终用户的影响权衡选项。

在这篇文章中，我们将讨论以下策略：

- Recreate（重新创建）：版本 A 终止，然后版本 B 推出。
- Ramped（也称为滚动更新或增量）：版本 B 慢慢推出并替换版本 A。
- Blue/Green : 版本 B 与版本 A 一起发布，然后流量切换到版本 B。
- Canary（金丝雀）：版本 B 发布给一部分用户，然后进行全面推出。
- A/B 测试：版本 B 在特定条件下发布给一部分用户。
- Shadow：版本 B 与版本 A 一起接收真实世界的流量，并且不影响响应。

让我们来看看每种策略，看看哪种策略最适合特定用例。为了简单起见，我们使用了Kubernetes并针对Minikube测试了示例。[可以在这个 git 存储库](https://github.com/ContainerSolutions/k8s-deployment-strategies)中找到每个策略的配置示例和分步方法。

## 重建部署

重新创建策略是一个虚拟部署，包括关闭版本 A，然后在关闭版本 A 后部署版本 B。这种技术意味着服务的停机时间取决于应用程序的关闭和启动持续时间。

![](/imgs/cd-recreate.gif)

**优点：**

- 易于设置。
- 申请状态完全更新。

**缺点：**

- 对用户影响很大，预计停机时间取决于应用程序的关闭和启动持续时间。

## 增量部署

增量部署策略包括通过一个接一个地替换实例来缓慢推出应用程序的一个版本，直到所有实例都推出。它通常遵循以下过程：*在负载均衡器后面使用版本 A 的池，部署版本 B 的一个实例。当服务准备好接受流量时，实例将添加到池中。然后，版本 A 的一个实例从池中删除并关闭。*

根据负责增量部署的系统，您可以调整以下参数以增加部署时间：

- 并行度，最大批处理大小：要推出的并发实例数。
- 最大冗余实例（Max surge）：除了当前数量之外要添加多少个实例。
- 最大不可用：滚动更新过程中不可用实例的数量。

![](/imgs/cd-ramped.gif)

**优点：**

- 易于设置。
- 版本在实例之间缓慢发布。
- 对于可以处理数据重新平衡的有状态应用程序来说很方便。

**缺点：**

- 推出/回滚可能需要时间。
- 支持多个 API 很难。
- 无法控制流量。


## 蓝绿

蓝/绿部署策略不同于增量部署，版本 B（绿色）与版本 A（蓝色）一起部署，实例数量完全相同。在测试新版本满足所有要求后，流量在负载均衡器级别从版本 A 切换到版本 B。

![](/imgs/cd-blue-green.gif)

**优点：**

- 实时推出/回滚。
- 避免版本控制问题，整个应用程序状态一次性更改。

**缺点：**

- 昂贵，因为它需要双倍的资源。
- 在发布到生产环境之前，应对整个平台进行适当的测试。
- 处理有状态的应用程序可能很困难。


## 金丝雀

金丝雀部署包括逐渐将生产流量从版本 A 转移到版本 B。通常流量根据权重进行拆分。例如，90% 的请求转到版本 A，10% 转到版本 B。

当测试缺乏或不可靠，或者对平台上新版本的稳定性缺乏信心时，通常会使用此技术。

![](/imgs/cd-canary.gif)

**优点：**

- 为部分用户发布的版本。
- 便于错误率和性能监控。
- 快速回滚。

**缺点：**

- 缓慢推出。

## A/B测试

A/B 测试部署包括在特定条件下将用户子集路由到新功能。它通常是一种根据统计数据做出业务决策的技术，而不是部署策略。但是，它是相关的，可以通过向金丝雀部署添加额外功能来实现，因此我们将在此处简要讨论。

这种技术广泛用于测试给定功能的转换，并且只推出转换最多的版本。

以下是可用于在版本之间分配流量的条件列表：

- 通过浏览器 cookie
- 查询参数
- 地理定位
- 技术支持：浏览器版本、屏幕尺寸、操作系统等。
- 语言

![](/imgs/cd-a-b.gif)

**优点：**

- 多个版本并行运行。
- 完全控制流量分配。

**缺点：**

- 需要智能负载平衡器。
- 很难对给定会话的错误进行故障排除，分布式跟踪成为强制性的。

## 影子部署

影子部署包括与版本 A 一起发布版本 B，分叉版本 A 的传入请求并将它们发送到版本 B，同时不影响生产流量。这对于测试新功能的生产负载特别有用。当稳定性和性能满足要求时，触发应用程序的上线。

这种技术设置起来相当复杂，需要特殊要求，尤其是出口流量。例如，给定一个购物车平台，如果您想对支付服务进行影子测试，您最终可能会让客户为他们的订单支付两次。在这种情况下，您可以通过创建一个复制来自提供者的响应的模拟服务来解决它。

![](/imgs/cd-shadow.gif)

**优点：**

- 使用生产流量对应用程序进行性能测试。
- 对用户没有影响。
- 直到应用程序的稳定性和性能满足要求后才能上线。

**缺点：**

- 昂贵，因为它需要双倍的资源。
- 不是真正的用户测试，可能会产生误导。
- 设置复杂。
- 某些情况下需要模拟服务。

## 总结

有多种方法可以部署新版本的应用程序，这实际上取决于需求和预算。发布到开发/暂存环境时，重新创建或增量部署通常是一个不错的选择。在生产方面，增量部署或蓝/绿部署通常很合适，但需要对新平台进行适当的测试。

蓝/绿和影子战略对预算的影响更大，因为它需要双倍的资源能力。如果应用程序缺乏测试或对软件的影响/稳定性缺乏信心，则可以使用金丝雀、a/b 测试或影子发布。

如果您的企业需要在特定用户群中测试新功能，这些用户群可以根据某些参数（如地理位置、语言、操作系统或浏览器功能）进行过滤，那么您可能需要使用 a/b 测试技术。

最后但同样重要的是，影子发布很复杂，需要额外的工作来模拟出口流量，这在使用可变操作（电子邮件、银行等）调用外部依赖项时是强制性的。但是，当迁移到新的数据库技术并使用影子流量来监控负载下的系统性能时，此技术可能很有用。

下图可帮助您选择正确的策略：

![](/imgs/cd_deployment_strategies.png)

